# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π —Å—Ä–µ–¥—ã –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ —Å OpenMP
import os
os.environ['KMP_DUPLICATE_LIB_OK'] = 'TRUE'

# –û—Å–Ω–æ–≤–Ω—ã–µ –∏–º–ø–æ—Ä—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞
import logging
import os
from telegram import Update, ReplyKeyboardMarkup
from telegram.ext import Application, CommandHandler, MessageHandler, filters, ContextTypes

# –î–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–∞–Ω–Ω—ã–º–∏ –∏ —Ñ–∞–π–ª–∞–º–∏
import json
from cryptography.fernet import Fernet
import pandas as pd
from openpyxl import load_workbook

# –î–ª—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
import sqlite3
from datetime import datetime
from functools import wraps

# –î–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏ –∫–æ–º–ø—å—é—Ç–µ—Ä–Ω–æ–≥–æ –∑—Ä–µ–Ω–∏—è
import cv2
import numpy as np
from pathlib import Path
import torch
from torchvision import transforms, models
from PIL import Image
import faiss
import pickle
from PIL import ImageEnhance
import uuid
import requests
from io import BytesIO
import time

# –ù–æ–≤—ã–µ –∏–º–ø–æ—Ä—Ç—ã –¥–ª—è CLIP
from transformers import CLIPProcessor, CLIPModel
import clip

# –ù–æ–≤—ã–π –∏–º–ø–æ—Ä—Ç –¥–ª—è YOLO
from ultralytics import YOLO

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –º–æ–¥–µ–ª–µ–π
image_model = None
feature_extractor = None
faiss_index = None
label_encoder = None
# –ù–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è CLIP
clip_model = None
clip_processor = None
clip_device = "cuda" if torch.cuda.is_available() else "cpu"
# –ù–æ–≤–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è –º–æ–¥–µ–ª–∏ YOLO
yolo_model = None
# –§–ª–∞–≥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è Cloudinary –≤–º–µ—Å—Ç–æ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞ - –≤—Å–µ–≥–¥–∞ False
use_cloudinary = False
# –ù–æ–≤—ã–π —Ñ–ª–∞–≥ –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è —É–ª—É—á—à–µ–Ω–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞
use_enhanced_search = True  # –í–∫–ª—é—á–∞–µ–º —É–ª—É—á—à–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫

def load_config(encrypted_file="config.encrypted"):
    """–ó–∞–≥—Ä—É–∂–∞–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∏–∑ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞"""
    try:
        # –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–ª—é—á —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è
        with open("key.key", "rb") as key_file:
            key = key_file.read()

        # –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è
        fernet = Fernet(key)

        # –ß–∏—Ç–∞–µ–º –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        with open(encrypted_file, "rb") as config_file:
            encrypted_data = config_file.read()

        # –†–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        decrypted_data = fernet.decrypt(encrypted_data)
        config = json.loads(decrypted_data.decode())

        logger.info("‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–∞")
        return config
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏: {e}")
        return None

def is_allowed_user(user_id):
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –µ—Å—Ç—å –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –±–µ–ª–æ–º —Å–ø–∏—Å–∫–µ"""
    try:
        config = load_config()
        whitelist = config.get('whitelist', [])
        return user_id in whitelist
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {e}")
        return False

def is_admin(user_id):
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º"""
    try:
        config = load_config()
        admins = config.get('admins', [])
        return user_id in admins
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞: {e}")
        return False

def initialize_image_search():
    """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥–µ–ª–µ–π –∏ –∏–Ω–¥–µ–∫—Å–æ–≤ –¥–ª—è –ø–æ–∏—Å–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º CLIP"""
    global image_model, feature_extractor, faiss_index, label_encoder
    global clip_model, clip_processor
    
    try:
        logger.info(f"–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥–µ–ª–µ–π –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ: {clip_device}")
        
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –º–æ–¥–µ–ª—å CLIP
        try:
            # –ü—Ä–æ–±—É–µ–º —Å–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–æ–¥–µ–ª—å —á–µ—Ä–µ–∑ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–µ—Ä—ã
            clip_model = CLIPModel.from_pretrained("openai/clip-vit-base-patch32")
            clip_processor = CLIPProcessor.from_pretrained("openai/clip-vit-base-patch32")
            logger.info("‚úÖ –ú–æ–¥–µ–ª—å CLIP –∑–∞–≥—Ä—É–∂–µ–Ω–∞ —á–µ—Ä–µ–∑ transformers")
        except Exception as e:
            logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å CLIP —á–µ—Ä–µ–∑ transformers: {e}")
            # –ü—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å —á–µ—Ä–µ–∑ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—É—é –±–∏–±–ª–∏–æ—Ç–µ–∫—É CLIP
            clip_model, clip_processor = clip.load("ViT-B/32", device=clip_device)
            logger.info("‚úÖ –ú–æ–¥–µ–ª—å CLIP –∑–∞–≥—Ä—É–∂–µ–Ω–∞ —á–µ—Ä–µ–∑ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—É—é –±–∏–±–ª–∏–æ—Ç–µ–∫—É")
        
        # –ü–µ—Ä–µ–≤–æ–¥–∏–º –º–æ–¥–µ–ª—å –≤ —Ä–µ–∂–∏–º –æ—Ü–µ–Ω–∫–∏
        clip_model.eval()
        
        # –ü–æ–ª—É—á–∞–µ–º —Ä–∞–∑–º–µ—Ä–Ω–æ—Å—Ç—å –≤–µ–∫—Ç–æ—Ä–∞ –æ—Ç CLIP (–æ–±—ã—á–Ω–æ 512)
        if hasattr(clip_model, 'visual') and hasattr(clip_model.visual, 'output_dim'):
            feature_dim = clip_model.visual.output_dim
        else:
            feature_dim = 512  # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ä–∞–∑–º–µ—Ä –¥–ª—è CLIP ViT-B/32
        
        logger.info(f"–†–∞–∑–º–µ—Ä–Ω–æ—Å—Ç—å –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ CLIP: {feature_dim}")
        
        # –°–æ–∑–¥–∞–µ–º –∏–Ω–¥–µ–∫—Å FAISS
        faiss_index = faiss.IndexFlatL2(feature_dim)
        
        # –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∏–Ω–¥–µ–∫—Å –µ—Å–ª–∏ –µ—Å—Ç—å
        if os.path.exists('clip_image_search_index.pkl'):
            try:
                with open('clip_image_search_index.pkl', 'rb') as f:
                    saved_data = pickle.load(f)
                    faiss_index = saved_data['index']
                    label_encoder = saved_data['labels']
                    # –ó–∞–≥—Ä—É–∂–∞–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
                    tool_metadata = saved_data.get('tool_metadata', {})
                logger.info(f"–ó–∞–≥—Ä—É–∂–µ–Ω —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π CLIP –∏–Ω–¥–µ–∫—Å —Å {faiss_index.ntotal} –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏")
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–Ω–¥–µ–∫—Å–∞ CLIP: {e}")
                # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –∏–Ω–¥–µ–∫—Å
                faiss_index = faiss.IndexFlatL2(feature_dim)
                label_encoder = []
        else:
            label_encoder = []
        
        logger.info("‚úÖ –ú–æ–¥–µ–ª–∏ –ø–æ–∏—Å–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π CLIP —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã")
        return True
        
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –º–æ–¥–µ–ª–µ–π CLIP: {e}")
        import traceback
        logger.error(f"–î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏: {traceback.format_exc()}")
        return False

def extract_features(image_path):
    """–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ –∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º CLIP –∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –¥–ª—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –≤ –∫–æ—Ä–æ–±–∫–∞—Ö"""
    try:
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞
        if not os.path.exists(image_path):
            logger.error(f"–§–∞–π–ª –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç: {image_path}")
            return None
            
        # –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        original_image = Image.open(image_path).convert('RGB')
        logger.info(f"–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ CLIP –∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: {os.path.basename(image_path)}")
        
        # –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ OpenCV –¥–ª—è –ø—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∏
        cv_img = cv2.imread(str(image_path))
        if cv_img is None:
            logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ OpenCV, –∏—Å–ø–æ–ª—å–∑—É–µ–º PIL: {image_path}")
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ PIL
            image = original_image
        else:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –º–æ–∂–µ—Ç –ª–∏ —ç—Ç–æ –±—ã—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –≤ –∫–æ—Ä–æ–±–∫–µ
            has_box = detect_tool_box(cv_img)
            
            # –ï—Å–ª–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –∫–æ—Ä–æ–±–∫–∞, –ø—ã—Ç–∞–µ–º—Å—è –∏–∑–≤–ª–µ—á—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç
            if has_box:
                logger.info(f"–û–±–Ω–∞—Ä—É–∂–µ–Ω –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –≤ –∫–æ—Ä–æ–±–∫–µ, –ø—Ä–∏–º–µ–Ω—è–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É")
                # –ü–æ–ª—É—á–∞–µ–º –æ–±—Ä–µ–∑–∞–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–º
                roi_img = extract_tool_from_box(cv_img)
                if roi_img is not None:
                    # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –æ–±—Ä–∞—Ç–Ω–æ –≤ PIL
                    image = Image.fromarray(cv2.cvtColor(roi_img, cv2.COLOR_BGR2RGB))
                    logger.info(f"–ò–∑–≤–ª–µ—á–µ–Ω –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –∏–∑ –∫–æ—Ä–æ–±–∫–∏")
                else:
                    # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å, –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª
                    image = original_image
                    logger.info(f"–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –∏–∑ –∫–æ—Ä–æ–±–∫–∏, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–ª–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ")
            else:
                # –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                image = original_image
        
        # –ü—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        # –ü–æ–≤—ã—à–∞–µ–º –∫–æ–Ω—Ç—Ä–∞—Å—Ç–Ω–æ—Å—Ç—å
        enhancer = ImageEnhance.Contrast(image)
        image = enhancer.enhance(1.3)  # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∫–æ–Ω—Ç—Ä–∞—Å—Ç –Ω–∞ 30%
        
        # –ü–æ–≤—ã—à–∞–µ–º —Ä–µ–∑–∫–æ—Å—Ç—å –¥–ª—è –ª—É—á—à–µ–≥–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π
        enhancer = ImageEnhance.Sharpness(image)
        image = enhancer.enhance(1.2)  # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ä–µ–∑–∫–æ—Å—Ç—å –Ω–∞ 20%
        
        with torch.no_grad():
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä CLIP –¥–ª—è –ø—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            if isinstance(clip_processor, CLIPProcessor):
                # –î–ª—è –≤–∞—Ä–∏–∞–Ω—Ç–∞ –∏–∑ transformers
                inputs = clip_processor(images=image, return_tensors="pt")
                image_features = clip_model.get_image_features(**inputs)
                image_features = image_features.cpu().numpy()[0]
            else:
                # –î–ª—è –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ CLIP
                image_tensor = clip_processor(image).unsqueeze(0).to(clip_device)
                image_features = clip_model.encode_image(image_tensor)
                image_features = image_features.cpu().numpy()[0]
            
            # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –≤–µ–∫—Ç–æ—Ä
            image_features = image_features / np.linalg.norm(image_features)
            
            logger.info(f"–£—Å–ø–µ—à–Ω–æ –∏–∑–≤–ª–µ—á–µ–Ω—ã CLIP –ø—Ä–∏–∑–Ω–∞–∫–∏ –∏–∑ {os.path.basename(image_path)}, —Ä–∞–∑–º–µ—Ä–Ω–æ—Å—Ç—å: {image_features.shape}")
            
            return image_features
            
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–∏ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ CLIP: {e}")
        import traceback
        logger.error(f"–î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏: {traceback.format_exc()}")
        return None

def detect_brand_from_filename(filename):
    """–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –±—Ä–µ–Ω–¥–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ –ø–æ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞"""
    # –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –±—Ä–µ–Ω–¥—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ —Å –±–æ–ª–µ–µ —Ç–æ—á–Ω—ã–º–∏ –∫–ª—é—á–µ–≤—ã–º–∏ —Å–ª–æ–≤–∞–º–∏
    known_brands = {
        # Makita
        'makita': 'Makita',
        '–º–∞–∫–∏—Ç–∞': 'Makita',
        
        # Dexter
        'dexter': 'Dexter',
        '–¥–µ–∫—Å—Ç–µ—Ä': 'Dexter',
        
        # DeWalt
        'dewalt': 'DeWalt',
        '–¥–µ–≤–æ–ª—å—Ç': 'DeWalt',
        'dewat': 'DeWalt',
        
        # Bosch
        'bosch': 'Bosch',
        '–±–æ—à': 'Bosch',
        
        # Metabo
        'metabo': 'Metabo',
        '–º–µ—Ç–∞–±–æ': 'Metabo',
        
        # Ryobi
        'ryobi': 'Ryobi',
        '—Ä–∏–æ–±–∏': 'Ryobi',
        
        # Hitachi/Hikoki
        'hitachi': 'Hitachi',
        'hikoki': 'Hitachi',
        '—Ö–∏—Ç–∞—á–∏': 'Hitachi',
        '—Ö–∏–∫–æ–∫–∏': 'Hitachi',
        
        # Milwaukee
        'milwaukee': 'Milwaukee',
        '–º–∏–ª—É–æ–∫–∏': 'Milwaukee',
        '–º–∏–ª–≤–æ–∫–∏': 'Milwaukee',
        
        # –ò–Ω—Ç–µ—Ä—Å–∫–æ–ª
        '–∏–Ω—Ç–µ—Ä—Å–∫–æ–ª': '–ò–Ω—Ç–µ—Ä—Å–∫–æ–ª',
        '–∏–Ω—Ç–µ—Ä': '–ò–Ω—Ç–µ—Ä—Å–∫–æ–ª',
        'intersk': '–ò–Ω—Ç–µ—Ä—Å–∫–æ–ª',
        
        # AEG
        'aeg': 'AEG',
        '–∞–µ–≥': 'AEG',
        
        # Festool
        'festool': 'Festool',
        '—Ñ–µ—Å—Ç—É–ª': 'Festool',
        
        # Hilti
        'hilti': 'Hilti',
        '—Ö–∏–ª—Ç–∏': 'Hilti'
    }
    
    # –û—á–∏—â–∞–µ–º –∏–º—è —Ñ–∞–π–ª–∞ –æ—Ç —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –∏ –ø—Ä–∏–≤–æ–¥–∏–º –∫ –Ω–∏–∂–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É
    clean_name = os.path.splitext(os.path.basename(filename))[0].lower()
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–º—è —Ñ–∞–π–ª–∞ –Ω–∞ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Å –∏–∑–≤–µ—Å—Ç–Ω—ã–º–∏ –±—Ä–µ–Ω–¥–∞–º–∏
    for brand_key, brand_name in known_brands.items():
        if brand_key in clean_name:
            return brand_name
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É
    path = os.path.dirname(filename).lower()
    for brand_key, brand_name in known_brands.items():
        if brand_key in path:
            return brand_name
    
    # –ï—Å–ª–∏ –±—Ä–µ–Ω–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º "–ù–µ–æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–π –±—Ä–µ–Ω–¥"
    return "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π"

def update_image_index(folder_path):
    """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º CLIP"""
    global faiss_index, label_encoder
    
    try:
        features_list = []
        paths_list = []
        
        # –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        image_files = list(Path(folder_path).glob('*.jpg')) + \
                      list(Path(folder_path).glob('*.jpeg')) + \
                      list(Path(folder_path).glob('*.png'))
        
        logger.info(f"–ù–∞–π–¥–µ–Ω–æ {len(image_files)} –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –¥–ª—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ CLIP")
        
        # –ò–Ω–¥–µ–∫—Å–∏—Ä—É–µ–º –∫–∞–∂–¥–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        for idx, img_path in enumerate(image_files):
            if idx % 5 == 0:
                logger.info(f"–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ {idx}/{len(image_files)} –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π")
                
            features = extract_features(str(img_path))
            if features is not None:
                features_list.append(features)
                paths_list.append(str(img_path))
                
                # –ë—Ä–µ–Ω–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞ –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
                brand = detect_brand_from_filename(str(img_path))
                if brand != "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π":
                    logger.info(f"–î–æ–±–∞–≤–ª–µ–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –±—Ä–µ–Ω–¥–∞ {brand}: {os.path.basename(str(img_path))}")
        
        # –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–µ–∫—Å
        if features_list:
            features_array = np.array(features_list).astype('float32')
            
            # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –∏–Ω–¥–µ–∫—Å
            feature_dim = features_array.shape[1]
            new_index = faiss.IndexFlatL2(feature_dim)
            new_index.add(features_array)
            
            faiss_index = new_index
            label_encoder = paths_list
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω–¥–µ–∫—Å
            with open('clip_image_search_index.pkl', 'wb') as f:
                pickle.dump({
                    'index': faiss_index,
                    'labels': label_encoder
                }, f)
            
            logger.info(f"‚úÖ –ò–Ω–¥–µ–∫—Å CLIP –æ–±–Ω–æ–≤–ª–µ–Ω, –¥–æ–±–∞–≤–ª–µ–Ω–æ {len(features_list)} –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π")
            return True
        else:
            logger.error("–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å CLIP –ø—Ä–∏–∑–Ω–∞–∫–∏ –Ω–∏ –∏–∑ –æ–¥–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è")
            return False
            
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∏–Ω–¥–µ–∫—Å–∞ CLIP: {e}")
        import traceback
        logger.error(f"–î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏: {traceback.format_exc()}")
        return False

def find_similar_images(query_image_path, folder_path=None, top_n=5, similarity_threshold=0.25):
    """–ü–æ–∏—Å–∫ –ø–æ—Ö–æ–∂–∏—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º CLIP –∏ —É–ª—É—á—à–µ–Ω–Ω–æ–π –∫–æ—Ä—Ä–µ–∫—Ü–∏–µ–π –ø–æ —Ç–∏–ø—É –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ –∏ –±—Ä–µ–Ω–¥—É"""
    try:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –º–æ–¥–µ–ª–µ–π
        if clip_model is None:
            if not initialize_image_search():
                return []
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∏–Ω–¥–µ–∫—Å–∞
        if faiss_index is None or faiss_index.ntotal == 0:
            logger.error("–ò–Ω–¥–µ–∫—Å CLIP –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –∏–ª–∏ –ø—É—Å—Ç")
            return []
                
        # –ò–∑–≤–ª–µ–∫–∞–µ–º –ø—Ä–∏–∑–Ω–∞–∫–∏ –∏–∑ –∑–∞–ø—Ä–æ—Å–∞
        query_features = extract_features(query_image_path)
        if query_features is None:
            logger.error("–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å CLIP –ø—Ä–∏–∑–Ω–∞–∫–∏ –∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞")
            return []
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –±—Ä–µ–Ω–¥ –ø–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é –∏ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
        query_brand = detect_brand_by_color(query_image_path)
        logger.info(f"–û–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π –±—Ä–µ–Ω–¥ –∑–∞–ø—Ä–æ—Å–∞ –ø–æ —Ü–≤–µ—Ç–∞–º: {query_brand}")
        
        filename_brand = detect_brand_from_filename(query_image_path)
        if filename_brand != "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π" and query_brand is None:
            query_brand = filename_brand
            logger.info(f"–ë—Ä–µ–Ω–¥ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –ø–æ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞: {query_brand}")
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
        tool_type, tool_type_ru, tool_confidence = classify_tool_type(query_image_path)
        logger.info(f"–û–ø—Ä–µ–¥–µ–ª–µ–Ω —Ç–∏–ø –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞: {tool_type_ru} —Å —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å—é {tool_confidence:.2f}")
        
        # –°–æ–∑–¥–∞–µ–º —Å–æ—Å—Ç–∞–≤–Ω–æ–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è CLIP, –æ–±—ä–µ–¥–∏–Ω—è—é—â–µ–µ –±—Ä–µ–Ω–¥ –∏ —Ç–∏–ø –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
        if query_brand and tool_type != "unknown":
            composite_description = f"{tool_type} by {query_brand} brand"
            logger.info(f"–°–æ—Å—Ç–∞–≤–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ: {composite_description}")
        elif query_brand:
            composite_description = f"power tool by {query_brand} brand"
            logger.info(f"–°–æ—Å—Ç–∞–≤–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–ª—å–∫–æ —Å –±—Ä–µ–Ω–¥–æ–º: {composite_description}")
        elif tool_type != "unknown":
            composite_description = f"{tool_type}"
            logger.info(f"–°–æ—Å—Ç–∞–≤–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–ª—å–∫–æ —Å —Ç–∏–ø–æ–º: {composite_description}")
        else:
            composite_description = "power tool"
            logger.info(f"–û–±—â–µ–µ –æ–ø–∏—Å–∞–Ω–∏–µ: {composite_description}")
        
        # –ë—Ä–µ–Ω–¥-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –æ–ø–∏—Å–∞–Ω–∏—è —Å —É—á–µ—Ç–æ–º —Ç–∏–ø–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
        brand_specific_prompts = {
            "Makita": {
                "power drill": "blue Makita power drill with black chuck",
                "screwdriver": "blue Makita cordless screwdriver with black handle",
                "hammer drill": "blue Makita hammer drill with SDS chuck",
                "angle grinder": "blue Makita angle grinder with protective guard"
            },
            "Dexter": {
                "power drill": "dark blue Dexter power drill with black chuck",
                "screwdriver": "dark blue Dexter cordless screwdriver with black handle",
                "hammer drill": "dark blue Dexter hammer drill with SDS chuck",
                "angle grinder": "dark blue Dexter angle grinder with protective guard"
            },
            "DeWalt": {
                "power drill": "yellow DeWalt power drill with black chuck",
                "screwdriver": "yellow DeWalt cordless screwdriver with black handle",
                "hammer drill": "yellow DeWalt hammer drill with SDS chuck",
                "angle grinder": "yellow DeWalt angle grinder with protective guard"
            }
        }
        
        # –ï—Å–ª–∏ –µ—Å—Ç—å –ø–æ–¥—Ö–æ–¥—è—â–∏–π —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ –±—Ä–µ–Ω–¥–∞ –∏ —Ç–∏–ø–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
        if query_brand in brand_specific_prompts and tool_type in brand_specific_prompts[query_brand]:
            specific_prompt = brand_specific_prompts[query_brand][tool_type]
            logger.info(f"–ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–π –ø—Ä–æ–º–ø—Ç: {specific_prompt}")
        
        # –ò—â–µ–º –ø–æ—Ö–æ–∂–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—é –∫–æ—Å–∏–Ω—É—Å–∞
        query_features = query_features.astype('float32').reshape(1, -1)
        distances, indices = faiss_index.search(
            query_features,
            min(top_n * 4, faiss_index.ntotal)  # –ë–µ—Ä–µ–º –±–æ–ª—å—à–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
        )
        
        # –ì–æ—Ç–æ–≤–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π –∫–æ—Ä—Ä–µ–∫—Ü–∏–µ–π –ø–æ —Ç–∏–ø—É –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ –∏ –±—Ä–µ–Ω–¥—É
        results = []
        processed_brands = set()  # –î–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –±—Ä–µ–Ω–¥–æ–≤
        
        for i, (dist, idx) in enumerate(zip(distances[0], indices[0])):
            if idx < len(label_encoder):
                image_path = label_encoder[idx]
                
                # –ë–∞–∑–æ–≤–∞—è —Å—Ö–æ–∂–µ—Å—Ç—å (–æ–±—Ä–∞—Ç–Ω–æ –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–∞ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—é)
                similarity = 1.0 / (1.0 + dist)
                
                # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –±—Ä–µ–Ω–¥ –Ω–∞–π–¥–µ–Ω–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                result_brand = detect_brand_by_color(image_path)
                
                # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ —Ü–≤–µ—Ç—É, –ø—Ä–æ–±—É–µ–º –ø–æ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
                if result_brand is None:
                    result_brand = detect_brand_from_filename(image_path)
                    if result_brand == "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π":
                        result_brand = None
                
                # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
                result_tool_type, result_tool_type_ru, result_tool_confidence = classify_tool_type(image_path)
                
                logger.info(f"–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ {os.path.basename(image_path)}: "
                           f"–±—Ä–µ–Ω–¥ {result_brand}, —Ç–∏–ø {result_tool_type_ru}, "
                           f"—Å—Ö–æ–∂–µ—Å—Ç—å {similarity:.3f}")
                
                # –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º —Å—Ö–æ–∂–µ—Å—Ç—å –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –±—Ä–µ–Ω–¥–∞ –∏ —Ç–∏–ø–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
                if similarity >= similarity_threshold:
                    brand_tool_adjusted_similarity = similarity
                    
                    # –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—é —Ç–∏–ø–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç #1)
                    if tool_type == result_tool_type and tool_type != "unknown":
                        # –ï—Å–ª–∏ —Ç–∏–ø—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ —Å–æ–≤–ø–∞–¥–∞—é—Ç - —Å–∏–ª—å–Ω–æ –ø–æ–≤—ã—à–∞–µ–º —Å—Ö–æ–∂–µ—Å—Ç—å
                        brand_tool_adjusted_similarity = similarity * 5.0
                        logger.info(f"–ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –∑–∞ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Ç–∏–ø–∞ {tool_type_ru}: {brand_tool_adjusted_similarity:.3f}")
                    elif tool_type != "unknown" and result_tool_type != "unknown" and tool_type != result_tool_type:
                        # –ï—Å–ª–∏ —Ç–∏–ø—ã —Ä–∞–∑–Ω—ã–µ - —Å–∏–ª—å–Ω–æ —Å–Ω–∏–∂–∞–µ–º —Å—Ö–æ–∂–µ—Å—Ç—å
                        brand_tool_adjusted_similarity = similarity * 0.1
                        logger.info(f"–ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –∑–∞ —Ä–∞–∑–Ω—ã–µ —Ç–∏–ø—ã {tool_type_ru}/{result_tool_type_ru}: {brand_tool_adjusted_similarity:.3f}")
                    
                    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—é –±—Ä–µ–Ω–¥–∞ (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç #2)
                    if query_brand and result_brand == query_brand:
                        # –ï—Å–ª–∏ –±—Ä–µ–Ω–¥—ã —Å–æ–≤–ø–∞–¥–∞—é—Ç - –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –ø–æ–≤—ã—à–∞–µ–º —Å—Ö–æ–∂–µ—Å—Ç—å
                        brand_tool_adjusted_similarity *= 2.0
                        logger.info(f"–ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –∑–∞ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –±—Ä–µ–Ω–¥–∞ {query_brand}: {brand_tool_adjusted_similarity:.3f}")
                    elif query_brand and result_brand and query_brand != result_brand:
                        # –†–∞–∑–Ω—ã–µ –±—Ä–µ–Ω–¥—ã - –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ —Å–Ω–∏–∂–∞–µ–º —Å—Ö–æ–∂–µ—Å—Ç—å
                        brand_tool_adjusted_similarity *= 0.3
                        logger.info(f"–ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –∑–∞ —Ä–∞–∑–Ω—ã–µ –±—Ä–µ–Ω–¥—ã {query_brand}/{result_brand}: {brand_tool_adjusted_similarity:.3f}")
                    
                    # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ —Å—Ö–æ–∂–µ—Å—Ç–∏ –¥–æ 1.0 (100%)
                    brand_tool_adjusted_similarity = min(brand_tool_adjusted_similarity, 1.0)
                    
                    # –î–æ–±–∞–≤–ª—è–µ–º –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –±—Ä–µ–Ω–¥–µ –∏ —Ç–∏–ø–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
                    results.append((
                        image_path, 
                        brand_tool_adjusted_similarity, 
                        result_brand, 
                        result_tool_type_ru
                    ))
                    
                    # –û—Ç–º–µ—á–∞–µ–º –±—Ä–µ–Ω–¥ –∫–∞–∫ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π
                    if result_brand is not None:
                        processed_brands.add(result_brand)
        
        # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Å—Ö–æ–∂–µ—Å—Ç–∏
        results = sorted(results, key=lambda x: x[1], reverse=True)
        
        # –ë–µ—Ä–µ–º —Ç–æ–ø-N —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        top_results = []
        for img_path, sim, brand, tool_type in results[:top_n]:
            top_results.append((img_path, sim))
            logger.info(f"–í—ã–±—Ä–∞–Ω–æ –≤ —Ç–æ–ø —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤: {os.path.basename(img_path)}, "
                      f"–±—Ä–µ–Ω–¥: {brand}, —Ç–∏–ø: {tool_type}, "
                      f"—Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ö–æ–∂–µ—Å—Ç—å: {sim:.3f}")
        
        return top_results
        
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Å CLIP: {e}")
        import traceback
        logger.error(f"–î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏: {traceback.format_exc()}")
        return []

def detect_brand_by_color(image_path):
    """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –±—Ä–µ–Ω–¥ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ –ø–æ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–Ω—ã–º —Ü–≤–µ—Ç–∞–º –∏ –ª–æ–≥–æ—Ç–∏–ø–∞–º"""
    try:
        # –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        img = cv2.imread(str(image_path))
        if img is None:
            return None
            
        # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ HSV
        hsv = cv2.cvtColor(img, cv2.COLOR_BGR2HSV)
        
        # –†–∞–∑–º–µ—Ä—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        height, width = img.shape[:2]
        total_pixels = height * width
        
        # –¶–≤–µ—Ç–æ–≤—ã–µ –¥–∏–∞–ø–∞–∑–æ–Ω—ã –¥–ª—è –±—Ä–µ–Ω–¥–æ–≤
        # Makita - –±–∏—Ä—é–∑–æ–≤—ã–π/—Å–∏–Ω–∏–π - —Ä–∞—Å—à–∏—Ä—è–µ–º –¥–∏–∞–ø–∞–∑–æ–Ω –¥–ª—è –ª—É—á—à–µ–≥–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è
        lower_makita = np.array([75, 40, 60])  # –ï—â–µ –±–æ–ª—å—à–µ —Ä–∞—Å—à–∏—Ä—è–µ–º –¥–∏–∞–ø–∞–∑–æ–Ω –¥–ª—è –ª—É—á—à–µ–≥–æ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è Makita
        upper_makita = np.array([130, 255, 255])
        makita_mask = cv2.inRange(hsv, lower_makita, upper_makita)
        makita_pixels = cv2.countNonZero(makita_mask)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç —Å–∏–Ω–µ–≥–æ —Ü–≤–µ—Ç–∞ –¥–ª—è Makita
        makita_percentage = (makita_pixels / total_pixels) * 100
        
        # –ï—Å–ª–∏ –±–æ–ª–µ–µ 8% –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–º–µ–µ—Ç —Å–∏–Ω–∏–π —Ü–≤–µ—Ç Makita, –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–∞–∫ Makita
        # –≠—Ç–æ –Ω–∞–º–Ω–æ–≥–æ –≤–∞–∂–Ω–µ–µ —Å–∞–º–æ–≥–æ –∫–æ–Ω—Ç—É—Ä–∞ –ª–æ–≥–æ—Ç–∏–ø–∞
        if makita_percentage > 8:
            logger.info(f"–û–ø—Ä–µ–¥–µ–ª–µ–Ω –±—Ä–µ–Ω–¥ Makita –ø–æ –ø—Ä–æ—Ü–µ–Ω—Ç—É —Å–∏–Ω–µ–≥–æ —Ü–≤–µ—Ç–∞: {makita_percentage:.1f}%")
            return "Makita"
        
        # –ò–Ω—Ç–µ—Ä—Å–∫–æ–ª - —Å–≤–µ—Ç–ª–æ-–±–∏—Ä—é–∑–æ–≤—ã–π (–±–æ–ª–µ–µ —Å–≤–µ—Ç–ª—ã–π —á–µ–º Makita)
        lower_interskol = np.array([80, 30, 130])
        upper_interskol = np.array([100, 80, 255])
        interskol_mask = cv2.inRange(hsv, lower_interskol, upper_interskol)
        
        # Dexter - –±–æ–ª–µ–µ –Ω–∞—Å—ã—â–µ–Ω–Ω—ã–π —Å–∏–Ω–∏–π
        lower_dexter = np.array([110, 170, 120])  # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –Ω–∞—Å—ã—â–µ–Ω–Ω–æ—Å—Ç—å –¥–ª—è —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è —Å Makita
        upper_dexter = np.array([130, 255, 255])
        dexter_mask = cv2.inRange(hsv, lower_dexter, upper_dexter)
        
        # DeWalt - –∂–µ–ª—Ç—ã–π
        lower_dewalt = np.array([20, 100, 100])
        upper_dewalt = np.array([30, 255, 255])
        dewalt_mask = cv2.inRange(hsv, lower_dewalt, upper_dewalt)
        
        # Milwaukee - –∫—Ä–∞—Å–Ω—ã–π
        lower_red1 = np.array([0, 120, 120])
        upper_red1 = np.array([10, 255, 255])
        lower_red2 = np.array([170, 120, 120])
        upper_red2 = np.array([180, 255, 255])
        mask_red1 = cv2.inRange(hsv, lower_red1, upper_red1)
        mask_red2 = cv2.inRange(hsv, lower_red2, upper_red2)
        milwaukee_mask = cv2.bitwise_or(mask_red1, mask_red2)
        
        # Bosch (–∑–µ–ª–µ–Ω—ã–π)
        lower_bosch = np.array([40, 100, 100])
        upper_bosch = np.array([70, 255, 255])
        bosch_mask = cv2.inRange(hsv, lower_bosch, upper_bosch)
        
        # Oasis (—è—Ä–∫–æ-–∑–µ–ª–µ–Ω—ã–π)
        lower_oasis = np.array([35, 150, 100])
        upper_oasis = np.array([75, 255, 255])
        oasis_mask = cv2.inRange(hsv, lower_oasis, upper_oasis)
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∏–∫—Å–µ–ª–µ–π –∫–∞–∂–¥–æ–≥–æ –±—Ä–µ–Ω–¥–∞
        interskol_pixels = cv2.countNonZero(interskol_mask)
        dexter_pixels = cv2.countNonZero(dexter_mask)
        dewalt_pixels = cv2.countNonZero(dewalt_mask)
        milwaukee_pixels = cv2.countNonZero(milwaukee_mask)
        bosch_pixels = cv2.countNonZero(bosch_mask)
        oasis_pixels = cv2.countNonZero(oasis_mask)
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ—Ä–æ–≥–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
        min_pixels = 300  # –°–Ω–∏–∂–∞–µ–º –ø–æ—Ä–æ–≥ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –¥–µ—Ç–µ–∫—Ü–∏–∏
        
        # –ü—Ä–æ–ø–æ—Ä—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        height, width = img.shape[:2]
        total_pixels = height * width
        
        # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –¥–ª—è –ø–æ–∏—Å–∫–∞ –ª–æ–≥–æ—Ç–∏–ø–æ–≤
        gray = cv2.cvtColor(img, cv2.COLOR_BGR2GRAY)
        _, thresh = cv2.threshold(gray, 150, 255, cv2.THRESH_BINARY_INV)
        
        # –°–æ–∑–¥–∞–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—É—é –º–∞—Å–∫—É –¥–ª—è –≤–µ—Ä—Ö–Ω–µ–π —á–∞—Å—Ç–∏ (–æ–±—ã—á–Ω–æ–µ –º–µ—Å—Ç–æ –¥–ª—è –ª–æ–≥–æ—Ç–∏–ø–æ–≤)
        top_mask = np.zeros_like(gray)
        top_mask[:height//3, :] = 255
        top_part = cv2.bitwise_and(thresh, top_mask)
        
        # –ù–∞—Ö–æ–¥–∏–º –∫–æ–Ω—Ç—É—Ä—ã –≤ –≤–µ—Ä—Ö–Ω–µ–π —á–∞—Å—Ç–∏
        contours, _ = cv2.findContours(top_part, cv2.RETR_EXTERNAL, cv2.CHAIN_APPROX_SIMPLE)
        
        # –í—ã–±–∏—Ä–∞–µ–º –∫–æ–Ω—Ç—É—Ä—ã –ø–æ–¥—Ö–æ–¥—è—â–µ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ (–ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ª–æ–≥–æ—Ç–∏–ø—ã)
        potential_logos = []
        for cnt in contours:
            area = cv2.contourArea(cnt)
            if area > 100 and area < total_pixels / 10:  # –ò—Å–∫–ª—é—á–∞–µ–º –æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏–µ –∏ –æ—á–µ–Ω—å –±–æ–ª—å—à–∏–µ
                x, y, w, h = cv2.boundingRect(cnt)
                aspect_ratio = float(w) / h if h > 0 else 0
                if 0.5 <= aspect_ratio <= 5.0:  # –õ–æ–≥–æ—Ç–∏–ø—ã –æ–±—ã—á–Ω–æ –∏–º–µ—é—Ç –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏
                    potential_logos.append(cnt)
        
        # –ü—Ä–æ—Ü–µ–Ω—Ç –ø–∏–∫—Å–µ–ª–µ–π –æ—Ç –æ–±—â–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –¥–æ–º–∏–Ω–∏—Ä—É—é—â–µ–≥–æ —Ü–≤–µ—Ç–∞
        color_threshold_percent = 0.5  # 0.5%
        color_threshold = total_pixels * color_threshold_percent / 100
        
        # –õ–æ–≥–∏—Ä—É–µ–º –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
        logger.info(f"–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –±—Ä–µ–Ω–¥–∞ –¥–ª—è {os.path.basename(image_path)}")
        logger.info(f"–ü–∏–∫—Å–µ–ª–∏ –±—Ä–µ–Ω–¥–æ–≤: Makita: {makita_pixels}, Dexter: {dexter_pixels}, " +
                   f"Milwaukee: {milwaukee_pixels}, DeWalt: {dewalt_pixels}, " +
                   f"–ò–Ω—Ç–µ—Ä—Å–∫–æ–ª: {interskol_pixels}, Bosch: {bosch_pixels}, " +
                   f"Oasis: {oasis_pixels}")
        logger.info(f"–ù–∞–π–¥–µ–Ω–æ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –ª–æ–≥–æ—Ç–∏–ø–æ–≤: {len(potential_logos)}")
        
        # –î–ª—è Oasis/–∑–µ–ª–µ–Ω–æ–π –¥—Ä–µ–ª–∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∑–µ–ª–µ–Ω–æ–≥–æ —Ü–≤–µ—Ç–∞ –∏ –ª–æ–≥–æ—Ç–∏–ø–∞
        if oasis_pixels > min_pixels * 3:  # –¢—Ä–µ–±—É–µ–º –±–æ–ª—å—à–µ –∑–µ–ª–µ–Ω—ã—Ö –ø–∏–∫—Å–µ–ª–µ–π –¥–ª—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ª–æ–≥–æ—Ç–∏–ø–∞ –≤ –≤–µ—Ä—Ö–Ω–µ–π —á–∞—Å—Ç–∏
            has_logo_in_top = False
            for cnt in potential_logos:
                x, y, w, h = cv2.boundingRect(cnt)
                if y < height // 3:  # –¢–æ–ª—å–∫–æ –≤ –≤–µ—Ä—Ö–Ω–µ–π —Ç—Ä–µ—Ç–∏
                    has_logo_in_top = True
                    break
            
            # –ï—Å–ª–∏ –µ—Å—Ç—å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–µ–ª–µ–Ω–æ–≥–æ —Ü–≤–µ—Ç–∞ –∏ –ª–æ–≥–æ—Ç–∏–ø –≤ –≤–µ—Ä—Ö–Ω–µ–π —á–∞—Å—Ç–∏
            if has_logo_in_top or oasis_pixels > color_threshold * 8:
                logger.info(f"–û–ø—Ä–µ–¥–µ–ª–µ–Ω –±—Ä–µ–Ω–¥ Oasis –ø–æ –∑–µ–ª–µ–Ω–æ–º—É —Ü–≤–µ—Ç—É: {oasis_pixels} –ø–∏–∫—Å–µ–ª–µ–π")
                return "Oasis"
        
        # –î–ª—è Makita –∏—â–µ–º —Ö–∞—Ä–∞–∫—Ç–µ—Ä–Ω—ã–π –ª–æ–≥–æ—Ç–∏–ø (–±—É–∫–≤—ã "MAKITA") –∏ —Ü–≤–µ—Ç
        if makita_pixels > min_pixels:
            # –ï—Å–ª–∏ –µ—Å—Ç—å –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–∏–Ω–µ–≥–æ –∏ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ª–æ–≥–æ—Ç–∏–ø—ã
            if makita_pixels > dexter_pixels and makita_pixels > interskol_pixels:
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–æ—Ö–æ–∂–∏ –ª–∏ –∫–æ–Ω—Ç—É—Ä—ã –Ω–∞ –±—É–∫–≤—ã
                letter_contours = 0
                for cnt in potential_logos:
                    x, y, w, h = cv2.boundingRect(cnt)
                    # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏ –∫–æ–Ω—Ç—É—Ä–æ–≤ –¥–ª—è –±—É–∫–≤
                    if 0.2 < w/h < 1.5 and 10 < w < 60 and 10 < h < 60:
                        letter_contours += 1
                
                # –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫–æ–Ω—Ç—É—Ä–æ–≤ –ø–æ—Ö–æ–∂–∏—Ö –Ω–∞ –±—É–∫–≤—ã –≤ —Å–æ—á–µ—Ç–∞–Ω–∏–∏ —Å —Ü–≤–µ—Ç–æ–º
                if letter_contours >= 2 or makita_pixels > color_threshold * 5:
                    return "Makita"
        
        # –î–ª—è Dexter –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –±–æ–ª–µ–µ —Å—Ç—Ä–æ–≥–æ –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏ –ª–æ–≥–æ—Ç–∏–ø–∞
        if dexter_pixels > min_pixels:
            # –ï—Å–ª–∏ —Å–∏–Ω–∏–π Dexter –¥–æ–º–∏–Ω–∏—Ä—É–µ—Ç –Ω–∞–¥ –¥—Ä—É–≥–∏–º–∏ –æ—Ç—Ç–µ–Ω–∫–∞–º–∏ —Å–∏–Ω–µ–≥–æ
            if dexter_pixels > makita_pixels and dexter_pixels > interskol_pixels:
                # –ò—â–µ–º —Ö–∞—Ä–∞–∫—Ç–µ—Ä–Ω—ã–µ –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω—ã–µ —Ñ–æ—Ä–º—ã –ª–æ–≥–æ—Ç–∏–ø–∞ Dexter
                rect_like_contours = 0
                for cnt in potential_logos:
                    x, y, w, h = cv2.boundingRect(cnt)
                    # Dexter –ª–æ–≥–æ—Ç–∏–ø –±–æ–ª–µ–µ –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω—ã–π
                    if 3 < w < 100 and 3 < h < 50 and w > h * 1.5:
                        rect_like_contours += 1
                
                # –£—á–∏—Ç—ã–≤–∞–µ–º –∫–∞–∫ —Ü–≤–µ—Ç, —Ç–∞–∫ –∏ —Ñ–æ—Ä–º—É –∫–æ–Ω—Ç—É—Ä–æ–≤
                if rect_like_contours >= 1 or dexter_pixels > color_threshold * 5:
                    return "Dexter"
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ò–Ω—Ç–µ—Ä—Å–∫–æ–ª - –µ—Å–ª–∏ –µ—Å—Ç—å —Ö–∞—Ä–∞–∫—Ç–µ—Ä–Ω—ã–π —Å–≤–µ—Ç–ª–æ-–±–∏—Ä—é–∑–æ–≤—ã–π —Ü–≤–µ—Ç
        if interskol_pixels > min_pixels:
            if interskol_pixels > makita_pixels * 0.8:
                # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∫–æ–Ω—Ç—É—Ä–æ–≤ –¥–ª—è –ò–Ω—Ç–µ—Ä—Å–∫–æ–ª
                for cnt in potential_logos:
                    x, y, w, h = cv2.boundingRect(cnt)
                    # –õ–æ–≥–æ—Ç–∏–ø –ò–Ω—Ç–µ—Ä—Å–∫–æ–ª –æ–±—ã—á–Ω–æ –∏–º–µ–µ—Ç —Ö–∞—Ä–∞–∫—Ç–µ—Ä–Ω—ã–µ –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏
                    if 1.5 < w/h < 5.0 and h < 40:
                        return "–ò–Ω—Ç–µ—Ä—Å–∫–æ–ª"
                
                # –ï—Å–ª–∏ –∫–æ–Ω—Ç—É—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã, –Ω–æ —Ü–≤–µ—Ç —è–≤–Ω–æ –ø—Ä–µ–æ–±–ª–∞–¥–∞–µ—Ç
                if interskol_pixels > color_threshold * 4:
                    return "–ò–Ω—Ç–µ—Ä—Å–∫–æ–ª"
        
        # –î–ª—è DeWalt - —è—Ä–∫–∏–π –∂–µ–ª—Ç—ã–π —Ü–≤–µ—Ç –∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–Ω—ã–π –ª–æ–≥–æ—Ç–∏–ø
        if dewalt_pixels > min_pixels:
            # –ï—Å–ª–∏ –º–Ω–æ–≥–æ –∂–µ–ª—Ç–æ–≥–æ —Ü–≤–µ—Ç–∞
            if dewalt_pixels > color_threshold * 3:
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω—ã—Ö –∂–µ–ª—Ç—ã—Ö –æ–±–ª–∞—Å—Ç–µ–π
                yellow_areas = 0
                yellow_contours, _ = cv2.findContours(dewalt_mask, cv2.RETR_EXTERNAL, cv2.CHAIN_APPROX_SIMPLE)
                for cnt in yellow_contours:
                    area = cv2.contourArea(cnt)
                    if area > 200:  # –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–æ–ª—å—à–∞—è –∂–µ–ª—Ç–∞—è –æ–±–ª–∞—Å—Ç—å
                        yellow_areas += 1
                
                if yellow_areas > 0 or dewalt_pixels > color_threshold * 6:
                    return "DeWalt"
        
        # –î–ª—è Milwaukee - –∫—Ä–∞—Å–Ω—ã–π —Ü–≤–µ—Ç
        if milwaukee_pixels > min_pixels:
            if milwaukee_pixels > color_threshold * 4:
                return "Milwaukee"
                
        # –î–ª—è Bosch - –∑–µ–ª–µ–Ω—ã–π —Ü–≤–µ—Ç
        if bosch_pixels > min_pixels:
            if bosch_pixels > color_threshold * 4:
                return "Bosch"
        
        # –ï—Å–ª–∏ –±–æ–ª—å—à–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–µ–ª–µ–Ω–æ–≥–æ —Ü–≤–µ—Ç–∞ –∏ –Ω–µ—Ç —á–µ—Ç–∫–æ–≥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
        if oasis_pixels > min_pixels * 2:
            if oasis_pixels > bosch_pixels:
                logger.info(f"–û–ø—Ä–µ–¥–µ–ª–µ–Ω –±—Ä–µ–Ω–¥ Oasis –ø–æ –ø—Ä–µ–æ–±–ª–∞–¥–∞–Ω–∏—é –∑–µ–ª–µ–Ω–æ–≥–æ: {oasis_pixels} –ø–∏–∫—Å–µ–ª–µ–π")
                return "Oasis"
        
        # –ï—Å–ª–∏ –±–æ–ª—å—à–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–∏–Ω–µ–≥–æ, –Ω–æ –Ω–µ—Ç —á–µ—Ç–∫–æ–≥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –º–µ–∂–¥—É Makita –∏ Dexter –∏ –ò–Ω—Ç–µ—Ä—Å–∫–æ–ª
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ –º–µ–∂–¥—É –Ω–∏–º–∏ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
        if makita_pixels > min_pixels * 2:
            if makita_pixels > dexter_pixels * 2 and makita_pixels > interskol_pixels * 2:
                return "Makita"
        
        if dexter_pixels > min_pixels * 2:
            if dexter_pixels > makita_pixels * 2 and dexter_pixels > interskol_pixels * 2:
                return "Dexter"
        
        if interskol_pixels > min_pixels * 2:
            if interskol_pixels > makita_pixels * 1.5 and interskol_pixels > dexter_pixels * 1.5:
                return "–ò–Ω—Ç–µ—Ä—Å–∫–æ–ª"
        
        # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –±—Ä–µ–Ω–¥ –æ–¥–Ω–æ–∑–Ω–∞—á–Ω–æ
        logger.info(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ–¥–Ω–æ–∑–Ω–∞—á–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –±—Ä–µ–Ω–¥ –¥–ª—è {os.path.basename(image_path)}")
        return None
        
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏ –±—Ä–µ–Ω–¥–∞ –ø–æ —Ü–≤–µ—Ç—É: {e}")
        import traceback
        logger.error(f"–î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏: {traceback.format_exc()}")
        return None

def classify_tool_type(image_path, clip_text_features=None):
    """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∏–ø –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º CLIP"""
    try:
        # –¢–∏–ø—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏
        tool_types = [
            "power drill", 
            "cordless drill",
            "cordless screwdriver",
            "screwdriver", 
            "impact driver",
            "hammer drill",
            "angle grinder", 
            "circular saw",
            "jigsaw",
            "miter saw",
            "rotary tool"
        ]
        
        # –†—É—Å—Å–∫–∏–µ —ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç—ã –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –≤—ã–≤–æ–¥–∞
        tool_types_ru = {
            "power drill": "–î—Ä–µ–ª—å", 
            "cordless drill": "–ê–∫–∫—É–º—É–ª—è—Ç–æ—Ä–Ω–∞—è –¥—Ä–µ–ª—å",
            "screwdriver": "–®—É—Ä—É–ø–æ–≤–µ—Ä—Ç",
            "cordless screwdriver": "–ê–∫–∫—É–º—É–ª—è—Ç–æ—Ä–Ω—ã–π —à—É—Ä—É–ø–æ–≤–µ—Ä—Ç",
            "impact driver": "–£–¥–∞—Ä–Ω—ã–π –≥–∞–π–∫–æ–≤–µ—Ä—Ç",
            "hammer drill": "–ü–µ—Ä—Ñ–æ—Ä–∞—Ç–æ—Ä",
            "angle grinder": "–£–≥–ª–æ–≤–∞—è —à–ª–∏—Ñ–º–∞—à–∏–Ω–∞", 
            "circular saw": "–¶–∏—Ä–∫—É–ª—è—Ä–Ω–∞—è –ø–∏–ª–∞",
            "jigsaw": "–≠–ª–µ–∫—Ç—Ä–æ–ª–æ–±–∑–∏–∫",
            "miter saw": "–¢–æ—Ä—Ü–æ–≤–æ—á–Ω–∞—è –ø–∏–ª–∞",
            "rotary tool": "–ú–Ω–æ–≥–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç"
        }
        
        # –£—Å–∏–ª–∏–≤–∞–µ–º –æ–ø–∏—Å–∞–Ω–∏—è –¥–ª—è –ª—É—á—à–µ–≥–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è
        enhanced_prompts = [
            "a power drill with visible chuck and motor",
            "a cordless battery-powered drill with black chuck",
            "a cordless screwdriver with battery pack and plastic housing",
            "a screwdriver with bit holder and trigger",
            "an impact driver with square drive head",
            "a hammer drill with SDS chuck and drill bits",
            "an angle grinder with cutting disc and guard",
            "a circular saw with round blade and base plate",
            "a jigsaw with thin vertical blade",
            "a miter saw with large circular blade and base",
            "a rotary tool with small head and various accessories"
        ]
        
        # –ü–æ–ª—É—á–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        image = Image.open(image_path).convert('RGB')
        
        # –ï—Å–ª–∏ –º–æ–¥–µ–ª—å CLIP –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞, –∑–∞–≥—Ä—É–∂–∞–µ–º
        global clip_model, clip_processor
        if clip_model is None:
            initialize_image_search()
        
        with torch.no_grad():
            # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            if isinstance(clip_processor, CLIPProcessor):
                # –î–ª—è —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–µ—Ä–æ–≤
                inputs = clip_processor(images=image, return_tensors="pt")
                image_features = clip_model.get_image_features(**inputs)
                
                # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –ø—Ä–æ–º–ø—Ç—ã
                text_inputs = clip_processor(text=enhanced_prompts, return_tensors="pt", padding=True)
                text_features = clip_model.get_text_features(**text_inputs)
                
                # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –≤–µ–∫—Ç–æ—Ä—ã
                image_features = image_features / image_features.norm(dim=1, keepdim=True)
                text_features = text_features / text_features.norm(dim=1, keepdim=True)
                
                # –°—á–∏—Ç–∞–µ–º —Å—Ö–æ–¥—Å—Ç–≤–æ
                similarity = (100.0 * image_features @ text_features.T).softmax(dim=1)
                similarity = similarity.cpu().numpy()[0]
            else:
                # –î–ª—è –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ CLIP
                image_tensor = clip_processor(image).unsqueeze(0).to(clip_device)
                text_tensor = clip.tokenize(enhanced_prompts).to(clip_device)
                
                # –ü–æ–ª—É—á–∞–µ–º —ç–º–±–µ–¥–¥–∏–Ω–≥–∏
                image_features = clip_model.encode_image(image_tensor)
                text_features = clip_model.encode_text(text_tensor)
                
                # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –≤–µ–∫—Ç–æ—Ä—ã
                image_features = image_features / image_features.norm(dim=1, keepdim=True)
                text_features = text_features / text_features.norm(dim=1, keepdim=True)
                
                # –°—á–∏—Ç–∞–µ–º —Å—Ö–æ–¥—Å—Ç–≤–æ
                similarity = (100.0 * (image_features @ text_features.T)).softmax(dim=1)
                similarity = similarity.cpu().numpy()[0]
            
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ª—É—á—à–∏–π —Ç–∏–ø –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
            best_match_idx = np.argmax(similarity)
            best_match = tool_types[best_match_idx]
            confidence = similarity[best_match_idx]
            
            # –ü–æ–ª—É—á–∞–µ–º —Ä—É—Å—Å–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ
            tool_type_ru = tool_types_ru.get(best_match, best_match)
            
            logger.info(f"–ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞: {tool_type_ru} ({best_match}) —Å —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å—é {confidence:.2f}")
            
            # –î–ª—è –æ—Ç–ª–∞–¥–∫–∏ –≤—ã–≤–æ–¥–∏–º –≤—Å–µ –∫–ª–∞—Å—Å—ã —Å –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—è–º–∏
            for i, tool in enumerate(tool_types):
                logger.info(f"  - {tool_types_ru.get(tool, tool)}: {similarity[i]:.4f}")
            
            return best_match, tool_type_ru, confidence
            
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Ç–∏–ø–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞: {e}")
        import traceback
        logger.error(f"–î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏: {traceback.format_exc()}")
        return "unknown", "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç", 0.0

async def photo_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π —Å –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤"""
    if not context.user_data.get("awaiting_photo", False):
        await update.message.reply_text("‚ö†Ô∏è –î–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ —Ñ–æ—Ç–æ —Å–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ '–ü–æ–∏—Å–∫ –ø–æ —Ñ–æ—Ç–æ' –≤ –º–µ–Ω—é –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–¥–µ–ª.")
        return

    # –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –æ—Ç–¥–µ–ª (–µ—Å–ª–∏ –µ—Å—Ç—å)
    selected_department = context.user_data.get("selected_department", "")
    department_emoji = selected_department.split()[0] if selected_department else "üì∏"

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–∞—á–∞–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏
    processing_message = await update.message.reply_text(
        f"{department_emoji} –ù–∞—á–∏–Ω–∞—é –æ–±—Ä–∞–±–æ—Ç–∫—É —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏...\n"
        "–≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è."
    )

    # –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏ –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è
    temp_files = []

    try:
        # –ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –æ—Ç–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º
        context.user_data["awaiting_photo"] = False

        config = load_config()
        photos_folder = config.get("photos_folder")

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –ø–∞–ø–∫–∏ —Å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è–º–∏ (–¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞)
        if not photos_folder or not os.path.exists(photos_folder):
            logger.warning(f"–ü–∞–ø–∫–∞ —Å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è–º–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞: {photos_folder}")
        
        # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –ø–∞–ø–∫—É, –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
        os.makedirs("temp", exist_ok=True)

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é, –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—É—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
        photo_file = await update.message.photo[-1].get_file()
        user_photo_path = os.path.join("temp", f"{photo_file.file_id}.jpg")
        temp_files.append(user_photo_path)

        await photo_file.download_to_drive(user_photo_path)
        logger.info(f"–§–æ—Ç–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª: {user_photo_path}")
        
        # –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Å—Ç–∞—Ç—É—Å–µ
        await processing_message.edit_text(
            f"{department_emoji} –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è –ø–æ–ª—É—á–µ–Ω–∞ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞.\n"
            "–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏ –∏—â—É –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã..."
        )

        # –ü—Ä–∏–º–µ–Ω—è–µ–º –ø—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        enhanced_photo_path = preprocess_image_for_search(user_photo_path)
        if enhanced_photo_path:
            logger.info(f"–ò—Å–ø–æ–ª—å–∑—É—é —É–ª—É—á—à–µ–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –ø–æ–∏—Å–∫–∞: {enhanced_photo_path}")
            search_photo_path = enhanced_photo_path
            temp_files.append(enhanced_photo_path)
        else:
            logger.warning("–ù–µ —É–¥–∞–ª–æ—Å—å —É–ª—É—á—à–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, –∏—Å–ø–æ–ª—å–∑—É—é –æ—Ä–∏–≥–∏–Ω–∞–ª")
            search_photo_path = user_photo_path
        
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –º–æ–¥–µ–ª–∏ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        if clip_model is None:
            await processing_message.edit_text(
                f"{department_emoji} –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã –ø–æ–∏—Å–∫–∞...\n"
                "–ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏."
            )
            if not initialize_image_search():
                await update.message.reply_text(
                    "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º—É –ø–æ–∏—Å–∫–∞.\n"
                    "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É."
                )
                return

        # –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–µ–∫—Å –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        if faiss_index is None or faiss_index.ntotal == 0:
            if not photos_folder or not os.path.exists(photos_folder):
                await update.message.reply_text(
                    "‚ùå –ü–∞–ø–∫–∞ —Å –±–∞–∑–æ–π –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.\n"
                    "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É."
                )
                return
                
            await processing_message.edit_text( 
                f"{department_emoji} –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π...\n"
                "–≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ."
            )
            if not update_image_index(photos_folder):
                await update.message.reply_text(
                    "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∏–Ω–¥–µ–∫—Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π.\n"
                    "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É."
                )
                return
        
        # –û–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏
        await processing_message.edit_text(
            f"{department_emoji} –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏...\n"
            "–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é..."
        )
        
        detected_tools = detect_tools_on_image(search_photo_path)
        
        # –ï—Å–ª–∏ –Ω–∞—à–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
        if len(detected_tools) > 1:
            logger.info(f"–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ {len(detected_tools)} –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏")
            await processing_message.edit_text(
                f"{department_emoji} –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ {len(detected_tools)} –æ–±—ä–µ–∫—Ç–æ–≤ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏.\n"
                "–ò—â—É –ø–æ—Ö–æ–∂–∏–µ —Ç–æ–≤–∞—Ä—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞..."
            )
            
            # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –ø–æ –æ—Ç–¥–µ–ª—å–Ω–æ—Å—Ç–∏
            all_results = []
            
            for i, tool in enumerate(detected_tools):
                # –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
                tool_image_path = extract_tool_by_bbox(search_photo_path, tool['bbox'])
                if tool_image_path:
                    temp_files.append(tool_image_path)
                    
                    # –ò—â–µ–º –ø–æ—Ö–æ–∂–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è —ç—Ç–æ–≥–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
                    similar_images = find_similar_images(tool_image_path, top_n=3, similarity_threshold=0.25)
                    
                    if similar_images:
                        # –ö–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä—É–µ–º —Ç–∏–ø –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
                        tool_type, tool_type_ru, _ = classify_tool_type(tool_image_path)
                        
                        # –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ–± –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–µ
                        all_results.append({
                            'tool_image': tool_image_path,
                            'similar_images': similar_images,
                            'tool_type': tool_type_ru,
                            'confidence': tool['confidence'],
                            'class_name': tool['class_name']
                        })
            
            # –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Å—Ç–∞—Ç—É—Å–µ –ø–æ–∏—Å–∫–∞
            await processing_message.delete()
            
            # –ï—Å–ª–∏ –Ω–∞—à–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ö–æ—Ç—è –±—ã –¥–ª—è –æ–¥–Ω–æ–≥–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
            if all_results:
                await update.message.reply_text(
                    f"{department_emoji} *–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ {len(all_results)} –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏*\n"
                    f"–ü–æ–∫–∞–∑—ã–≤–∞—é —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞:",
                    parse_mode='Markdown'
                )
                
                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
                for i, result in enumerate(all_results):
                    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—ã—Ä–µ–∑–∞–Ω–Ω–æ–≥–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
                    await update.message.reply_photo(
                        open(result['tool_image'], 'rb'),
                        caption=f"üîç –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç #{i+1}\n"  # –£–±–∏—Ä–∞–µ–º —Ç–∏–ø –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ –∏–∑ –æ–ø–∏—Å–∞–Ω–∏—è
                               f"–ù–∞–π–¥–µ–Ω–æ –ø–æ—Ö–æ–∂–∏—Ö —Ç–æ–≤–∞—Ä–æ–≤: {len(result['similar_images'])}",
                        parse_mode='Markdown'
                    )
                    
                    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ—Ö–æ–∂–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è —ç—Ç–æ–≥–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
                    for j, (image_path, similarity_score) in enumerate(result['similar_images']):
                        try:
                            with open(image_path, "rb") as file:
                                similarity_percent = min(similarity_score * 100, 100)
                                await update.message.reply_photo(
                                    file, 
                                    caption=f"üìå –†–µ–∑—É–ª—å—Ç–∞—Ç #{j+1} –¥–ª—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ #{i+1}\n"
                                           f"–°—Ö–æ–∂–µ—Å—Ç—å: {similarity_percent:.0f}%"
                                )
                        except Exception as e:
                            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è {image_path}: {e}")
                
                # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –∫ –≤—ã–±–æ—Ä—É –æ—Ç–¥–µ–ª–∞
                keyboard = [["üîô –ù–∞–∑–∞–¥ –∫ –≤—ã–±–æ—Ä—É –æ—Ç–¥–µ–ª–∞"], ["üîô –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é"]]
                reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)
                
                await update.message.reply_text(
                    "–•–æ—Ç–∏—Ç–µ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø–æ–∏—Å–∫ –≤ –¥—Ä—É–≥–æ–º –æ—Ç–¥–µ–ª–µ –∏–ª–∏ —Å –¥—Ä—É–≥–æ–π —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–µ–π?",
                    reply_markup=reply_markup
                )
            else:
                # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –∫–Ω–æ–ø–∫–∞–º–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
                keyboard = [["üîô –ù–∞–∑–∞–¥ –∫ –≤—ã–±–æ—Ä—É –æ—Ç–¥–µ–ª–∞"], ["üîô –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é"]]
                reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)
                
                await update.message.reply_text(
                    f"{department_emoji} *–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –ø–æ—Ö–æ–∂–∏–µ —Ç–æ–≤–∞—Ä—ã –¥–ª—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤*\n\n"
                    "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–¥–µ–ª–∞—Ç—å –±–æ–ª–µ–µ —á–µ—Ç–∫–∏–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤.",
                    reply_markup=reply_markup,
                    parse_mode='Markdown'
                )
        else:
            # –ï—Å–ª–∏ –Ω–∞—à–ª–∏ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –∏–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –Ω–∏ –æ–¥–Ω–æ–≥–æ, –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—â–∏–π –ø–æ–∏—Å–∫
            await processing_message.edit_text(
                f"{department_emoji} –ü–æ–∏—Å–∫ –ø–æ—Ö–æ–∂–∏—Ö —Ç–æ–≤–∞—Ä–æ–≤...\n"
                f"–°—Ä–∞–≤–Ω–∏–≤–∞—é —Å –±–∞–∑–æ–π —Ç–æ–≤–∞—Ä–æ–≤ –≤ –æ—Ç–¥–µ–ª–µ {selected_department if selected_department else '—Ç–æ–≤–∞—Ä–æ–≤'}."
            )
            
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø–æ–∏—Å–∫ –∏–ª–∏ —É–ª—É—á—à–µ–Ω–Ω—ã–π –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            if use_enhanced_search:
                similar_images = enhanced_image_search(search_photo_path, top_n=5, similarity_threshold=0.25)
                logger.info("–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —É–ª—É—á—à–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π")
            else:
                similar_images = find_similar_images(search_photo_path, top_n=5, similarity_threshold=0.25)
                logger.info("–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –±–∞–∑–æ–≤—ã–π –ø–æ–∏—Å–∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π")
                
            logger.info(f"–ù–∞–π–¥–µ–Ω–æ –ø–æ—Ö–æ–∂–∏—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π: {len(similar_images) if similar_images else 0}")
            
            # –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Å—Ç–∞—Ç—É—Å–µ –ø–æ–∏—Å–∫–∞
            await processing_message.delete()
            
            if similar_images:
                # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                tool_type, tool_type_ru, _ = classify_tool_type(search_photo_path)
                
                # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –±—Ä–µ–Ω–¥ –∑–∞–ø—Ä–æ—Å–∞ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–∏ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–µ —Å—Ö–æ–∂–µ—Å—Ç–∏
                query_brand = detect_brand_by_color(search_photo_path)
                if query_brand is None:
                    query_brand = detect_brand_from_filename(search_photo_path)
                    if query_brand == "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π":
                        query_brand = None
                        
                logger.info(f"–ó–∞–ø—Ä–æ—Å: –æ–ø—Ä–µ–¥–µ–ª–µ–Ω —Ç–∏–ø –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ {tool_type_ru}, –±—Ä–µ–Ω–¥ {query_brand}")
                
                result_text = f"{department_emoji} *–ù–∞–π–¥–µ–Ω–æ {len(similar_images)} –ø–æ—Ö–æ–∂–∏—Ö —Ç–æ–≤–∞—Ä–æ–≤*\n"
                if selected_department:
                    result_text += f"–í –æ—Ç–¥–µ–ª–µ: *{selected_department}*\n"
                result_text += "–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –ø–æ —Å—Ç–µ–ø–µ–Ω–∏ —Å—Ö–æ–∂–µ—Å—Ç–∏:"
                
                await update.message.reply_text(
                    result_text,
                    parse_mode='Markdown'
                )
                
                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                for idx, (image_path, similarity_score) in enumerate(similar_images, start=1):
                    try:
                        with open(image_path, "rb") as file:
                            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –±—Ä–µ–Ω–¥ —Ç–æ–ª—å–∫–æ –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
                            result_brand = detect_brand_by_color(image_path)
                            if result_brand is None:
                                result_brand = detect_brand_from_filename(image_path)
                                if result_brand == "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π":
                                    result_brand = None
                            
                            if result_brand:
                                logger.info(f"–†–µ–∑—É–ª—å—Ç–∞—Ç #{idx}: –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –±—Ä–µ–Ω–¥ (–Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è): {result_brand}")
                            
                            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
                            result_type, result_type_ru, _ = classify_tool_type(image_path)
                            
                            caption = f"{department_emoji} –†–µ–∑—É–ª—å—Ç–∞—Ç #{idx}\n"
                            
                            # –ü—Ä–∏–º–µ–Ω—è–µ–º –Ω–µ–ª–∏–Ω–µ–π–Ω—É—é —à–∫–∞–ª—É –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–æ—Ü–µ–Ω—Ç–∞ —Å—Ö–æ–∂–µ—Å—Ç–∏
                            # –≠—Ç–æ –ø–æ–∑–≤–æ–ª–∏—Ç –ø–æ–≤—ã—Å–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è —Ä–µ–∞–ª—å–Ω—ã—Ö —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π
                            # –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∏–∑–∫–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –ø–ª–æ—Ö–∏—Ö —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π
                            
                            # –î–ª—è –ø–µ—Ä–≤–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –≤—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã—Å–æ–∫—É—é —Å—Ö–æ–∂–µ—Å—Ç—å
                            if idx == 1 and similarity_score > 0.3:
                                display_similarity = 100
                            else:
                                # –ù–µ–ª–∏–Ω–µ–π–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏–π
                                enhanced_similarity = similarity_score ** 0.5  # –ö–æ—Ä–µ–Ω—å –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã–π
                                display_similarity = min(enhanced_similarity * 100, 100)
                                
                                # –ï—Å–ª–∏ —ç—Ç–æ Makita vs Makita –∏–ª–∏ –¥—Ä—É–≥–æ–µ —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –±—Ä–µ–Ω–¥–∞ –∏ —Ç–∏–ø–∞
                                if result_brand and result_brand == query_brand and result_type == tool_type:
                                    display_similarity = max(display_similarity, 85)  # –ú–∏–Ω–∏–º—É–º 85% –¥–ª—è —Ç–æ—á–Ω—ã—Ö —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π
                            
                            caption += f"–°—Ö–æ–∂–µ—Å—Ç—å: {display_similarity:.0f}%"
                            
                            await update.message.reply_photo(
                                file, 
                                caption=caption
                            )
                    except Exception as e:
                        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è {image_path}: {e}")
                        await update.message.reply_text(
                            f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ #{idx}"
                        )
                
                # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –∫ –≤—ã–±–æ—Ä—É –æ—Ç–¥–µ–ª–∞
                keyboard = [["üîô –ù–∞–∑–∞–¥ –∫ –≤—ã–±–æ—Ä—É –æ—Ç–¥–µ–ª–∞"], ["üîô –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é"]]
                reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)
                
                await update.message.reply_text(
                    "–•–æ—Ç–∏—Ç–µ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø–æ–∏—Å–∫ –≤ –¥—Ä—É–≥–æ–º –æ—Ç–¥–µ–ª–µ –∏–ª–∏ —Å –¥—Ä—É–≥–æ–π —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–µ–π?",
                    reply_markup=reply_markup
                )
            else:
                # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –∫–Ω–æ–ø–∫–∞–º–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
                keyboard = [["üîô –ù–∞–∑–∞–¥ –∫ –≤—ã–±–æ—Ä—É –æ—Ç–¥–µ–ª–∞"], ["üîô –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é"]]
                reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)
                
                await update.message.reply_text(
                    f"{department_emoji} *–ü–æ—Ö–æ–∂–∏–µ —Ç–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã*\n\n"
                    "–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:\n"
                    "‚Ä¢ –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–¥–µ–ª–∞—Ç—å –¥—Ä—É–≥—É—é —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é\n"
                    "‚Ä¢ –£–ª—É—á—à–∏—Ç–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ\n"
                    "‚Ä¢ –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–æ–π –æ—Ç–¥–µ–ª\n"
                    "‚Ä¢ –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ç–æ–≤–∞—Ä —Ö–æ—Ä–æ—à–æ –≤–∏–¥–µ–Ω",
                    reply_markup=reply_markup,
                    parse_mode='Markdown'
                )

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏: {e}")
        import traceback
        logger.error(f"–î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏: {traceback.format_exc()}")
        
        # –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –ø—Ä–æ—Ü–µ—Å—Å–µ –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å
        try:
            await processing_message.delete()
        except:
            pass
            
        # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞
        keyboard = [["üîô –ù–∞–∑–∞–¥ –∫ –≤—ã–±–æ—Ä—É –æ—Ç–¥–µ–ª–∞"], ["üîô –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é"]]
        reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)
            
        await update.message.reply_text(
            "‚ö†Ô∏è –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏.\n"
            "–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏ –±—ã–ª–∏ –∑–∞–ø–∏—Å–∞–Ω—ã –≤ –∂—É—Ä–Ω–∞–ª.\n\n"
            "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.",
            reply_markup=reply_markup
        )

    finally:
        # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
        try:
            for file_path in temp_files:
                if os.path.exists(file_path):
                    os.remove(file_path)
                    logger.info(f"–í—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª —É–¥–∞–ª–µ–Ω: {file_path}")
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤: {e}")

async def search_in_colors(query: str, excel_file: str, context) -> list:
    """
    –ü–æ–∏—Å–∫ –≤ –±–∞–∑–µ —Ü–≤–µ—Ç–æ–≤ –ø–æ –∫–æ–ª–æ–Ω–∫–µ '–¶–≤–µ—Ç'
    """
    try:
        # –ß–∏—Ç–∞–µ–º Excel —Ñ–∞–π–ª
        df = pd.read_excel(excel_file)
        logger.info(f"–ó–∞–≥—Ä—É–∂–µ–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ —Ü–≤–µ—Ç–æ–≤. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫: {len(df)}")
        logger.info(f"–ö–æ–ª–æ–Ω–∫–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ: {df.columns.tolist()}")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫–æ–ª–æ–Ω–∫–∏ '–¶–≤–µ—Ç'
        if '–¶–≤–µ—Ç' not in df.columns:
            logger.error("‚ùå –í —Ç–∞–±–ª–∏—Ü–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∫–æ–ª–æ–Ω–∫–∞ '–¶–≤–µ—Ç'")
            return ["‚ùå –û—à–∏–±–∫–∞ –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ —Ç–∞–±–ª–∏—Ü—ã"]

        # –£–¥–∞–ª—è–µ–º –ø—Ä–æ–±–µ–ª—ã –∏–∑ –∑–∞–ø—Ä–æ—Å–∞ –∏ –ø—Ä–∏–≤–æ–¥–∏–º –∫ –Ω–∏–∂–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É
        query = query.lower().strip()
        logger.info(f"–ü–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å: {query}")

        # –ü–æ–∏—Å–∫ –≤ –∫–æ–ª–æ–Ω–∫–µ '–¶–≤–µ—Ç'
        mask = df['–¶–≤–µ—Ç'].astype(str).str.lower().str.contains(query, na=False)
        matches = df[mask]
        
        logger.info(f"–ù–∞–π–¥–µ–Ω–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π: {len(matches)}")
        
        if not matches.empty:
            # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è
            results = []
            for _, row in matches.iterrows():
                result_parts = []
                for col in df.columns:
                    value = row[col]
                    if col == '–¶–≤–µ—Ç':
                        result_parts.append(f"üé® *{value}*")
                    else:
                        if pd.notna(value):  # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–µ NaN
                            # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —á–∏—Å–ª–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                            formatted_value = format_numeric_value(value)
                            result_parts.append(f"‚Ä¢ {col}: {formatted_value}")
                
                results.append("\n".join(result_parts))
            return results
        else:
            # –í—ã–≤–æ–¥–∏–º –ø–µ—Ä–≤—ã–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
            logger.info("–ü—Ä–∏–º–µ—Ä—ã –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Ç–∞–±–ª–∏—Ü—ã:")
            logger.info(df['–¶–≤–µ—Ç'].head().to_string())
            return ["‚ùå –ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å."]
                
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ —Ü–≤–µ—Ç–æ–≤: {e}")
        return ["‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ"]

async def search_in_stores(query: str, excel_file: str, context) -> list:
    """
    –ü–æ–∏—Å–∫ –≤ –±–∞–∑–µ –º–∞–≥–∞–∑–∏–Ω–æ–≤ –ø–æ –∏—Ö –Ω–∞–∑–≤–∞–Ω–∏—é –∏ –∞–¥—Ä–µ—Å—É
    """
    try:
        # –ß–∏—Ç–∞–µ–º Excel —Ñ–∞–π–ª
        df = pd.read_excel(excel_file)
        logger.info(f"–ó–∞–≥—Ä—É–∂–µ–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ –º–∞–≥–∞–∑–∏–Ω–æ–≤. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫: {len(df)}")
        logger.info(f"–ö–æ–ª–æ–Ω–∫–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ: {df.columns.tolist()}")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –∫–æ–ª–æ–Ω–æ–∫
        required_columns = ['–ù–∞–∑–≤–∞–Ω–∏–µ', '–ê–¥—Ä–µ—Å']
        missing_columns = [col for col in required_columns if col not in df.columns]
        
        if missing_columns:
            logger.error(f"‚ùå –í —Ç–∞–±–ª–∏—Ü–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –∫–æ–ª–æ–Ω–∫–∏: {', '.join(missing_columns)}")
            return ["‚ùå –û—à–∏–±–∫–∞ –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ —Ç–∞–±–ª–∏—Ü—ã –º–∞–≥–∞–∑–∏–Ω–æ–≤"]

        # –ü—Ä–∏–≤–æ–¥–∏–º –∑–∞–ø—Ä–æ—Å –∫ –Ω–∏–∂–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É
        query = query.lower().strip()
        logger.info(f"–ü–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –¥–ª—è –º–∞–≥–∞–∑–∏–Ω–æ–≤: {query}")

        # –ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏ –∞–¥—Ä–µ—Å—É
        matches = df[
            df['–ù–∞–∑–≤–∞–Ω–∏–µ'].astype(str).str.lower().str.contains(query, na=False) |
            df['–ê–¥—Ä–µ—Å'].astype(str).str.lower().str.contains(query, na=False)
        ]
        
        logger.info(f"–ù–∞–π–¥–µ–Ω–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π: {len(matches)}")
        
        if not matches.empty:
            # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
            results = []
            for _, row in matches.iterrows():
                store_info = [f"üè™ *{row['–ù–∞–∑–≤–∞–Ω–∏–µ']}*"]
                
                for col in df.columns:
                    if col != '–ù–∞–∑–≤–∞–Ω–∏–µ':
                        value = row[col]
                        if pd.notna(value):  # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–µ NaN
                            if col == '–ê–¥—Ä–µ—Å':
                                store_info.append(f"üìç –ê–¥—Ä–µ—Å: {value}")
                            else:
                                store_info.append(f"‚Ä¢ {col}: {value}")
                
                results.append("\n".join(store_info))
            
            return results
        else:
            # –í—ã–≤–æ–¥–∏–º –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
            logger.info("–ü—Ä–∏–º–µ—Ä—ã –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Ç–∞–±–ª–∏—Ü—ã:")
            logger.info(df[['–ù–∞–∑–≤–∞–Ω–∏–µ', '–ê–¥—Ä–µ—Å']].head().to_string())
            return []
                
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –º–∞–≥–∞–∑–∏–Ω–æ–≤: {e}")
        return ["‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –º–∞–≥–∞–∑–∏–Ω–æ–≤"]

async def search_in_skobyanka(query: str, excel_file: str, context) -> list:
    """
    –ü–æ–∏—Å–∫ –≤ –±–∞–∑–µ —Å–∫–æ–±—è–Ω—ã—Ö –∏–∑–¥–µ–ª–∏–π
    """
    try:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–∞
        if not os.path.exists(excel_file):
            logger.error(f"‚ùå –§–∞–π–ª —Å–∫–æ–±—è–Ω–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω: {excel_file}")
            return ["‚ùå –§–∞–π–ª —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö –Ω–µ –Ω–∞–π–¥–µ–Ω"]
            
        # –ß–∏—Ç–∞–µ–º Excel —Ñ–∞–π–ª
        df = pd.read_excel(excel_file)
        logger.info(f"–ó–∞–≥—Ä—É–∂–µ–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ —Å–∫–æ–±—è–Ω–∫–∏. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫: {len(df)}")
        logger.info(f"–ö–æ–ª–æ–Ω–∫–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ: {df.columns.tolist()}")
        
        # –£–¥–∞–ª—è–µ–º –ø—Ä–æ–±–µ–ª—ã –∏–∑ –∑–∞–ø—Ä–æ—Å–∞ –∏ –ø—Ä–∏–≤–æ–¥–∏–º –∫ –Ω–∏–∂–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É
        query = query.lower().strip()
        logger.info(f"–ü–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –¥–ª—è —Å–∫–æ–±—è–Ω–∫–∏: {query}")

        # –ü–æ–∏—Å–∫ –ø–æ –≤—Å–µ–º –∫–æ–ª–æ–Ω–∫–∞–º
        matches = df.apply(
            lambda row: any(
                str(value).lower().find(query) != -1 
                for value in row if pd.notna(value)
            ), 
            axis=1
        )
        
        results_df = df[matches]
        logger.info(f"–ù–∞–π–¥–µ–Ω–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π: {len(results_df)}")
        
        if not results_df.empty:
            # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è
            results = []
            for _, row in results_df.iterrows():
                result_parts = []
                
                # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –æ—Å–Ω–æ–≤–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ/–∞—Ä—Ç–∏–∫—É–ª
                name_column = next((col for col in ['–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ', '–¢–æ–≤–∞—Ä', '–ê—Ä—Ç–∏–∫—É–ª'] if col in df.columns), df.columns[0])
                result_parts.append(f"üîß *{row[name_column]}*")
                
                # –î–æ–±–∞–≤–ª—è–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è
                for col in df.columns:
                    if col != name_column:
                        value = row[col]
                        if pd.notna(value):  # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–µ NaN
                            result_parts.append(f"‚Ä¢ {col}: {value}")
                
                results.append("\n".join(result_parts))
            
            return results[:10]  # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–æ 10 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        else:
            return []
                
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ —Å–∫–æ–±—è–Ω–∫–∏: {e}")
        import traceback
        logger.error(f"–î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏: {traceback.format_exc()}")
        return ["‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ"]

async def colors_base_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Ä–∞–∑–¥–µ–ª–∞ —Ü–≤–µ—Ç–æ–≤"""
    user_id = update.effective_user.id

    # –õ–æ–≥–∏—Ä—É–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã
    analytics = context.bot_data.get('analytics')
    if analytics:
        analytics.log_command("colors", user_id)

    if not is_allowed_user(user_id):
        await show_error_message(update, "access_denied")
        return

    # –õ–æ–≥–∏—Ä—É–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã
    analytics = context.bot_data.get('analytics')
    if analytics:
        analytics.log_command("colors", user_id)

    keyboard = [
        ["üîô –ù–∞–∑–∞–¥ –≤ —Ç–æ–≤–∞—Ä—ã"]
    ]
    reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)
    
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–∏—Å–∫–∞ —Ü–≤–µ—Ç–æ–≤
    context.user_data['state'] = 'searching_colors'
    
    await update.message.reply_text(
        "*üé® –ü–æ–∏—Å–∫ –≤ –±–∞–∑–µ —Ü–≤–µ—Ç–æ–≤*\n\n"
        "–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ü–≤–µ—Ç–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞.\n"
        "–ú–æ–∂–Ω–æ –∏—Å–∫–∞—Ç—å –ø–æ:\n"
        "‚Ä¢ –ù–∞–∑–≤–∞–Ω–∏—é —Ü–≤–µ—Ç–∞\n"
        "‚Ä¢ –ö–æ–¥—É —Ü–≤–µ—Ç–∞\n"
        "‚Ä¢ –ö–æ–º–±–∏–Ω–∞—Ü–∏–∏ —Å–ª–æ–≤\n\n"
        "üí° _–ü—Ä–∏–º–µ—Ä: —Å–µ—Ä—ã–π –º–µ—Ç–∞–ª–ª–∏–∫_",
        reply_markup=reply_markup,
        parse_mode='Markdown'
    )

async def back_to_contacts_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ —Ä–∞–∑–¥–µ–ª –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤"""
    await contacts_handler(update, context)


async def egais_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –ï–ì–ê–ò–°"""
    user_id = update.effective_user.id
    
    if not is_allowed_user(user_id):
        await show_error_message(update, "access_denied")
        return

    # –õ–æ–≥–∏—Ä—É–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã
    analytics = context.bot_data.get('analytics')
    if analytics:
        analytics.log_command("egais", user_id)

    try:
        # –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
        config = load_config()
        if not config:
            await update.message.reply_text("‚ùå –û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é")
            return

        # –ü–æ–ª—É—á–∞–µ–º –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É
        file_path = os.path.join(os.path.dirname(os.path.abspath(__file__)), 'data', 'les_ega.pdf')
        
        if not os.path.exists(file_path):
            await update.message.reply_text("‚ùå –§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω")
            return

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∞–π–ª
        await update.message.reply_document(
            document=open(file_path, 'rb'),
            filename='les_ega.pdf',
            caption="üìÑ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –ï–ì–ê–ò–°"
        )

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ñ–∞–π–ª–∞ –ï–ì–ê–ò–°: {e}")
        await update.message.reply_text("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ñ–∞–π–ª–∞")


# –°–ø–∏—Å–æ–∫ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (whitelist)
whitelist = [2093834331]

async def check_whitelist_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ whitelist"""
    user_id = update.effective_user.id
    
    if user_id not in whitelist:
        await update.message.reply_text("‚õî –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥–µ.")
        return

    if whitelist:
        users = "*–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤ whitelist:*\n" + "\n".join([str(user) for user in whitelist])
    else:
        users = "‚ùå –í whitelist –Ω–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π."

    await update.message.reply_text(users, parse_mode='Markdown')


async def admin_panel_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏"""
    user_id = update.effective_user.id
    config = load_config()

    if user_id not in config.get('admins', []):
        await update.message.reply_text(
            "‚õî *–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω*\n"
            "–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.",
            parse_mode='Markdown'
        )
        return

    # –õ–æ–≥–∏—Ä—É–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã
    analytics = context.bot_data.get('analytics')
    if analytics:
        analytics.log_command("admin_panel", user_id)

    keyboard = [
        ["üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏"],
        ["üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", "üîÑ –û–±–Ω–æ–≤–∏—Ç—å –±–∞–∑—ã"],
        ["üîô –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é"]
    ]
    reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)

    await update.message.reply_text(
        "*üõ†Ô∏è –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞*\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:\n"
        "‚Ä¢ üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ - –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ/—É–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π\n"
        "‚Ä¢ üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ - –ø—Ä–æ—Å–º–æ—Ç—Ä —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –±–æ—Ç–∞\n"
        "‚Ä¢ üîÑ –û–±–Ω–æ–≤–∏—Ç—å –±–∞–∑—ã - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö\n\n"
        "üí° _–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏_",
        reply_markup=reply_markup,
        parse_mode='Markdown'
    )


async def user_management_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ä–∞–∑–¥–µ–ª–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏"""
    user_id = update.effective_user.id
    config = load_config()

    if user_id not in config.get('admins', []):
        await update.message.reply_text("‚õî –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω")
        return

    keyboard = [
        ["‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è", "‚ûñ –£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"],
        ["üìã –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"],
        ["üîô –ù–∞–∑–∞–¥ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å"]
    ]
    reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)

    await update.message.reply_text(
        "*üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏*\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:\n"
        "‚Ä¢ –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n"
        "‚Ä¢ –£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n"
        "‚Ä¢ –ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π",
        reply_markup=reply_markup,
        parse_mode='Markdown'
    )

async def remove_user_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    user_id = update.effective_user.id
    config = load_config()

    if user_id not in config.get('admins', []):
        await update.message.reply_text("‚õî –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω")
        return

    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
    context.user_data['state'] = 'awaiting_remove_user_id'

    await update.message.reply_text(
        "*‚ûñ –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è*\n\n"
        "–û—Ç–ø—Ä–∞–≤—å—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∫–æ—Ç–æ—Ä–æ–≥–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å.",
        parse_mode='Markdown'
    )

async def add_to_whitelist_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ whitelist"""
    user_id = update.effective_user.id
    
    if user_id not in whitelist:
        await update.message.reply_text("‚õî –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥–µ.")
        return

    if context.args:
        new_user_id = context.args[0]
        if new_user_id not in whitelist:
            whitelist.append(new_user_id)
            await update.message.reply_text(f"‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {new_user_id} –¥–æ–±–∞–≤–ª–µ–Ω –≤ whitelist.")
        else:
            await update.message.reply_text("‚ùå –≠—Ç–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –≤ whitelist.")
    else:
        await update.message.reply_text("‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è.")


async def statistics_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –±–æ—Ç–∞"""
    try:
        user_id = update.effective_user.id
        config = load_config()

        if user_id not in config.get('admins', []):
            await update.message.reply_text("‚õî –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω")
            return

        # –ü–æ–ª—É—á–∞–µ–º –∞–Ω–∞–ª–∏—Ç–∏–∫—É –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –±–æ—Ç–∞
        analytics = context.bot_data.get('analytics')
        if not analytics:
            await update.message.reply_text("‚ùå –û—à–∏–±–∫–∞: —Å–∏—Å—Ç–µ–º–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞")
            return

        # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∫–æ–º–∞–Ω–¥
        command_stats = analytics.get_command_stats()

        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π
        stats_message = "*üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –±–æ—Ç–∞*\n\n"

        # –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Å–ª–æ–≤–∞—Ä—å –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞ –Ω–∞–∑–≤–∞–Ω–∏–π –∫–æ–º–∞–Ω–¥
        command_names = {
            'start': 'üöÄ –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞',
            'help': '‚ùì –ü–æ–º–æ—â—å',
            'contacts': 'üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã',
            'products': 'üì¶ –¢–æ–≤–∞—Ä—ã',
            'documents': 'üìÑ –î–æ–∫—É–º–µ–Ω—Ç—ã',
            'stores': 'üè™ –ü–æ–∏—Å–∫ –º–∞–≥–∞–∑–∏–Ω–æ–≤',
            'colors': 'üé® –ü–æ–∏—Å–∫ —Ü–≤–µ—Ç–æ–≤',
            'colors_base': 'üé® –ë–∞–∑–∞ —Ü–≤–µ—Ç–æ–≤',
            'skobyanka': 'üîß –°–∫–æ–±—è–Ω–∫–∞',
            'admin_panel': '‚öôÔ∏è –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å',
            'photo_search': 'üì∏ –ü–æ–∏—Å–∫ –ø–æ —Ñ–æ—Ç–æ',
            'back_to_menu': 'üîô –í–æ–∑–≤—Ä–∞—Ç –≤ –º–µ–Ω—é',
            'add_user': '‚ûï –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è',
            'remove_user': '‚ûñ –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è',
            'text_search': 'üîç –¢–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫',
            'maps': 'üó∫Ô∏è –ö–∞—Ä—Ç—ã',
            'logistics': 'üöö –õ–æ–≥–∏—Å—Ç–∏–∫–∞',
            'egais': 'üìã –ï–ì–ê–ò–°',
            'unknown_command': '‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞'
        }

        # –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∫–æ–º–∞–Ω–¥
        if command_stats:
            stats_message += "*–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥:*\n"
            for command, count in command_stats:
                friendly_name = command_names.get(command, f"üîπ {command}")  # –î–æ–±–∞–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä –¥–ª—è –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –∫–æ–º–∞–Ω–¥
                stats_message += f"‚Ä¢ {friendly_name}: {count} —Ä–∞–∑\n"
        else:
            stats_message += "üìù –ü–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ–± –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –∫–æ–º–∞–Ω–¥\n"

        # –î–æ–±–∞–≤–ª—è–µ–º —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å
        stats_message += "\n"

        # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –≤–æ–∑–≤—Ä–∞—Ç–∞
        keyboard = [["üîô –ù–∞–∑–∞–¥ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å"]]
        reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤
        await update.message.reply_text(
            stats_message.replace(".", "\\.").replace("-", "\\-").replace("_", "\\_"),
            parse_mode='MarkdownV2',
            reply_markup=reply_markup
        )

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: {e}")
        await update.message.reply_text(
            "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏\n"
            f"–î–µ—Ç–∞–ª–∏: {str(e)}"
        )

async def add_user_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    user_id = update.effective_user.id
    config = load_config()

    if user_id not in config.get('admins', []):
        await update.message.reply_text("‚õî –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω")
        return

    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    context.user_data['state'] = 'awaiting_new_user_id'

    await update.message.reply_text(
        "*‚ûï –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è*\n\n"
        "–û—Ç–ø—Ä–∞–≤—å—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∫–æ—Ç–æ—Ä–æ–≥–æ —Ö–æ—Ç–∏—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å.",
        parse_mode='Markdown'
    )


async def list_users_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"""
    user_id = update.effective_user.id
    config = load_config()

    if user_id not in config.get('admins', []):
        await update.message.reply_text("‚õî –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω")
        return

    whitelist = config.get('whitelist', [])
    admins = config.get('admins', [])

    if not whitelist:
        await update.message.reply_text("‚ùå –í —Å–ø–∏—Å–∫–µ –Ω–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.")
        return

    # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ —Å–ø–∏—Å–∫–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    message = "*üë• –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π*\n\n"
    
    for idx, uid in enumerate(whitelist, 1):
        admin_mark = "üëë " if uid in admins else ""
        message += f"{idx}. {admin_mark}ID: `{uid}`\n"

    message += "\nüí° _–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –æ—Ç–º–µ—á–µ–Ω—ã –∑–Ω–∞—á–∫–æ–º_ üëë"

    await update.message.reply_text(
        message,
        parse_mode='Markdown'
    )


async def back_to_admin_panel_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å"""
    await admin_panel_handler(update, context)


async def start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"""
    user_id = update.effective_user.id
    username = update.effective_user.username or "–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"
    
    # –õ–æ–≥–∏—Ä—É–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã
    analytics = context.bot_data.get('analytics')
    if analytics:
        analytics.log_command("start", user_id)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –±–µ–ª–æ–º —Å–ø–∏—Å–∫–µ
    if not is_allowed_user(user_id):
        await update.message.reply_text(
            f"‚õî <b>–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω</b>\n\n"
            f"–í–∞—à ID: <code>{user_id}</code>\n\n"
            f"–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.",
            parse_mode='HTML'
        )
        return
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é
    keyboard = [
        ["üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã", "üì∏ –ü–æ–∏—Å–∫ –ø–æ —Ñ–æ—Ç–æ"],
        # ["üì¶ –¢–æ–≤–∞—Ä—ã", "üìÑ –î–æ–∫—É–º–µ–Ω—Ç—ã"], # –í—Ä–µ–º–µ–Ω–Ω–æ —Å–∫—Ä—ã—Ç–æ
        ["‚ùì –ü–æ–º–æ—â—å"]
    ]
    
    # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤
    # –£–±—Ä–∞–Ω–æ: –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å —Ç–µ–ø–µ—Ä—å –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –∫–æ–º–∞–Ω–¥—É /admin
    # config = load_config()
    # if user_id in config.get('admins', []):
    #     keyboard.append(["‚öôÔ∏è –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å"])
    
    reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    await update.message.reply_text(
        f"üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {username}!\n\n"
        f"–í—ã–±–µ—Ä–∏—Ç–µ –Ω—É–∂–Ω—ã–π —Ä–∞–∑–¥–µ–ª —Å –ø–æ–º–æ—â—å—é –∫–Ω–æ–ø–æ–∫ –º–µ–Ω—é:\n"
        f"‚Ä¢ üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–∞–≥–∞–∑–∏–Ω–∞—Ö\n"
        # f"‚Ä¢ üì¶ –¢–æ–≤–∞—Ä—ã - –∫–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤\n" # –í—Ä–µ–º–µ–Ω–Ω–æ —Å–∫—Ä—ã—Ç–æ
        # f"‚Ä¢ üìÑ –î–æ–∫—É–º–µ–Ω—Ç—ã - –¥–æ—Å—Ç—É–ø –∫ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º\n" # –í—Ä–µ–º–µ–Ω–Ω–æ —Å–∫—Ä—ã—Ç–æ
        f"‚Ä¢ üì∏ –ü–æ–∏—Å–∫ –ø–æ —Ñ–æ—Ç–æ - –ø–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é\n"
        f"‚Ä¢ ‚ùì –ü–æ–º–æ—â—å - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–æ—Ç–µ\n\n"
        f"üí° <i>–î–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É –≤ –º–µ–Ω—é</i>",
        reply_markup=reply_markup,
        parse_mode='HTML'
    )

def preprocess_image_for_search(image_path):
    """–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –∫–∞—á–µ—Å—Ç–≤–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è"""
    try:
        # –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        img = cv2.imread(image_path)
        if img is None:
            logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –ø—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∏: {image_path}")
            return None
            
        # –ü–æ–ª—É—á–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        height, width = img.shape[:2]
        
        # –ï—Å–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–µ, —É–º–µ–Ω—å—à–∞–µ–º –µ–≥–æ –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
        max_dimension = 1024
        if max(height, width) > max_dimension:
            scale = max_dimension / max(height, width)
            new_width = int(width * scale)
            new_height = int(height * scale)
            img = cv2.resize(img, (new_width, new_height), interpolation=cv2.INTER_AREA)
            logger.info(f"–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É–º–µ–Ω—å—à–µ–Ω–æ –¥–æ {new_width}x{new_height}")
            
        # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ RGB –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å PIL
        img_rgb = cv2.cvtColor(img, cv2.COLOR_BGR2RGB)
        img_pil = Image.fromarray(img_rgb)
        
        # –£–ª—É—á—à–∞–µ–º –∫–æ–Ω—Ç—Ä–∞—Å—Ç
        contrast_enhancer = ImageEnhance.Contrast(img_pil)
        enhanced_img = contrast_enhancer.enhance(1.2)  # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∫–æ–Ω—Ç—Ä–∞—Å—Ç –Ω–∞ 20%
        
        # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ä–µ–∑–∫–æ—Å—Ç—å –¥–ª—è –ª—É—á—à–µ–≥–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π
        sharpness_enhancer = ImageEnhance.Sharpness(enhanced_img)
        enhanced_img = sharpness_enhancer.enhance(1.3)  # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ä–µ–∑–∫–æ—Å—Ç—å –Ω–∞ 30%
        
        # –ù–µ–º–Ω–æ–≥–æ —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º —è—Ä–∫–æ—Å—Ç—å, –µ—Å–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–µ–º–Ω–æ–µ
        brightness_enhancer = ImageEnhance.Brightness(enhanced_img)
        enhanced_img = brightness_enhancer.enhance(1.1)  # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —è—Ä–∫–æ—Å—Ç—å –Ω–∞ 10%
        
        # –£–ª—É—á—à–∞–µ–º –Ω–∞—Å—ã—â–µ–Ω–Ω–æ—Å—Ç—å —Ü–≤–µ—Ç–æ–≤ –¥–ª—è –ª—É—á—à–µ–≥–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –±—Ä–µ–Ω–¥–æ–≤
        color_enhancer = ImageEnhance.Color(enhanced_img)
        enhanced_img = color_enhancer.enhance(1.2)  # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –Ω–∞—Å—ã—â–µ–Ω–Ω–æ—Å—Ç—å –Ω–∞ 20%
        
        # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –ø—É—Ç—å –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        base_path, ext = os.path.splitext(image_path)
        enhanced_path = f"{base_path}_enhanced{ext}"
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        enhanced_img.save(enhanced_path)
        logger.info(f"–°–æ–∑–¥–∞–Ω–æ —É–ª—É—á—à–µ–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ: {enhanced_path}")
        
        return enhanced_path
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: {e}")
        import traceback
        logger.error(f"–î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏: {traceback.format_exc()}")
        return None

def enhanced_image_search(query_image_path, top_n=5, similarity_threshold=0.25):
    """
    –£–ª—É—á—à–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫ –ø–æ—Ö–æ–∂–∏—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –º—É–ª—å—Ç–∏–º–æ–¥–∞–ª—å–Ω–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞.
    –°–æ–∑–¥–∞–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å —Ä–∞–∑–Ω—ã–º–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞–º–∏ –∏ –∫–æ–º–±–∏–Ω–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã.
    
    Args:
        query_image_path: –ü—É—Ç—å –∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é –¥–ª—è –ø–æ–∏—Å–∫–∞
        top_n: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞
        similarity_threshold: –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø–æ—Ä–æ–≥ —Å—Ö–æ–∂–µ—Å—Ç–∏
        
    Returns:
        –°–ø–∏—Å–æ–∫ –∫–æ—Ä—Ç–µ–∂–µ–π (–ø—É—Ç—å_–∫_–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é, —Å—Ö–æ–∂–µ—Å—Ç—å)
    """
    try:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞
        if not os.path.exists(query_image_path):
            logger.error(f"–§–∞–π–ª –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç: {query_image_path}")
            return []
        
        # –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –≤–∞—Ä–∏–∞—Ü–∏–π
        original_image = Image.open(query_image_path).convert('RGB')
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ –∏ –±—Ä–µ–Ω–¥ –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ - —ç—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞
        query_tool_type, query_tool_type_ru, tool_confidence = classify_tool_type(query_image_path)
        query_brand = detect_brand_by_color(query_image_path)
        if query_brand is None:
            query_brand = detect_brand_from_filename(query_image_path)
            if query_brand == "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π":
                query_brand = None
                
        logger.info(f"–ó–∞–ø—Ä–æ—Å: –æ–ø—Ä–µ–¥–µ–ª–µ–Ω —Ç–∏–ø –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ {query_tool_type_ru} —Å —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å—é {tool_confidence:.2f}")
        logger.info(f"–ó–∞–ø—Ä–æ—Å: –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –±—Ä–µ–Ω–¥ {query_brand}")
        
        # –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤–∞—Ä–∏–∞—Ü–∏–π
        variation_files = []
        
        # 1. –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        original_results = find_similar_images(query_image_path, top_n=top_n*2, similarity_threshold=similarity_threshold)
        
        # 2. –í–∞—Ä–∏–∞—Ü–∏—è —Å —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–º –∫–æ–Ω—Ç—Ä–∞—Å—Ç–æ–º
        contrast_path = os.path.join("temp", f"contrast_{uuid.uuid4()}.jpg")
        contrast_enhancer = ImageEnhance.Contrast(original_image)
        contrast_img = contrast_enhancer.enhance(1.5)  # –ó–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∫–æ–Ω—Ç—Ä–∞—Å—Ç
        contrast_img.save(contrast_path)
        variation_files.append(contrast_path)
        contrast_results = find_similar_images(contrast_path, top_n=top_n*2, similarity_threshold=similarity_threshold)
        
        # 3. –í–∞—Ä–∏–∞—Ü–∏—è —Å —É–≤–µ–ª–∏—á–µ–Ω–Ω–æ–π —Ä–µ–∑–∫–æ—Å—Ç—å—é
        sharpness_path = os.path.join("temp", f"sharp_{uuid.uuid4()}.jpg")
        sharpness_enhancer = ImageEnhance.Sharpness(original_image)
        sharp_img = sharpness_enhancer.enhance(1.8)  # –ó–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ä–µ–∑–∫–æ—Å—Ç—å
        sharp_img.save(sharpness_path)
        variation_files.append(sharpness_path)
        sharp_results = find_similar_images(sharpness_path, top_n=top_n*2, similarity_threshold=similarity_threshold)
        
        # 4. –í–∞—Ä–∏–∞—Ü–∏—è —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π —è—Ä–∫–æ—Å—Ç—å—é
        brightness_path = os.path.join("temp", f"bright_{uuid.uuid4()}.jpg")
        brightness_enhancer = ImageEnhance.Brightness(original_image)
        bright_img = brightness_enhancer.enhance(1.3)  # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —è—Ä–∫–æ—Å—Ç—å
        bright_img.save(brightness_path)
        variation_files.append(brightness_path)
        bright_results = find_similar_images(brightness_path, top_n=top_n*2, similarity_threshold=similarity_threshold)
        
        # 5. –í–∞—Ä–∏–∞—Ü–∏—è —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π –Ω–∞—Å—ã—â–µ–Ω–Ω–æ—Å—Ç—å—é —Ü–≤–µ—Ç–æ–≤
        color_path = os.path.join("temp", f"color_{uuid.uuid4()}.jpg")
        color_enhancer = ImageEnhance.Color(original_image)
        color_img = color_enhancer.enhance(1.4)  # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –Ω–∞—Å—ã—â–µ–Ω–Ω–æ—Å—Ç—å
        color_img.save(color_path)
        variation_files.append(color_path)
        color_results = find_similar_images(color_path, top_n=top_n*2, similarity_threshold=similarity_threshold)
        
        # –û–±—ä–µ–¥–∏–Ω—è–µ–º –≤—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ –æ–¥–∏–Ω —Å–ª–æ–≤–∞—Ä—å –¥–ª—è —É—Å—Ä–µ–¥–Ω–µ–Ω–∏—è
        combined_results = {}
        
        # –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ—Ç –∫–∞–∂–¥–æ–π –≤–∞—Ä–∏–∞—Ü–∏–∏ —Å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–º–∏ –≤–µ—Å–∞–º–∏
        for path, sim in original_results:
            combined_results[path] = {'similarity': sim, 'count': 1, 'total': sim}
            
        for path, sim in contrast_results:
            if path in combined_results:
                combined_results[path]['total'] += sim * 0.8  # –í–µ—Å 0.8 –¥–ª—è –∫–æ–Ω—Ç—Ä–∞—Å—Ç–∞
                combined_results[path]['count'] += 1
            else:
                combined_results[path] = {'similarity': sim * 0.8, 'count': 1, 'total': sim * 0.8}
                
        for path, sim in sharp_results:
            if path in combined_results:
                combined_results[path]['total'] += sim * 0.9  # –í–µ—Å 0.9 –¥–ª—è —Ä–µ–∑–∫–æ—Å—Ç–∏
                combined_results[path]['count'] += 1
            else:
                combined_results[path] = {'similarity': sim * 0.9, 'count': 1, 'total': sim * 0.9}
                
        for path, sim in bright_results:
            if path in combined_results:
                combined_results[path]['total'] += sim * 0.7  # –í–µ—Å 0.7 –¥–ª—è —è—Ä–∫–æ—Å—Ç–∏
                combined_results[path]['count'] += 1
            else:
                combined_results[path] = {'similarity': sim * 0.7, 'count': 1, 'total': sim * 0.7}
                
        for path, sim in color_results:
            if path in combined_results:
                combined_results[path]['total'] += sim * 0.85  # –í–µ—Å 0.85 –¥–ª—è —Ü–≤–µ—Ç–∞
                combined_results[path]['count'] += 1
            else:
                combined_results[path] = {'similarity': sim * 0.85, 'count': 1, 'total': sim * 0.85}
        
        # –ü–æ—Å—Ç-–æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Å –ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏–µ–π —Ç–∏–ø–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ –∏ –±—Ä–µ–Ω–¥–∞
        weighted_results = []
        for path, data in combined_results.items():
            # –ë–∞–∑–æ–≤–∞—è —Å—Ä–µ–¥–Ω–µ–≤–∑–≤–µ—à–µ–Ω–Ω–∞—è —Å—Ö–æ–∂–µ—Å—Ç—å
            avg_similarity = data['total'] / data['count']
            
            # –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π
            confidence_boost = min(data['count'] / 5 * 0.2, 0.2)  # –ú–∞–∫—Å–∏–º—É–º 20% –±—É—Å—Ç–∞
            
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
            result_tool_type, result_tool_type_ru, _ = classify_tool_type(path)
            
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –±—Ä–µ–Ω–¥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
            result_brand = detect_brand_by_color(path)
            if result_brand is None:
                result_brand = detect_brand_from_filename(path)
                if result_brand == "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π":
                    result_brand = None
            
            # –ë–∞–∑–æ–≤–∞—è —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ö–æ–∂–µ—Å—Ç—å —Å —É—á–µ—Ç–æ–º —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π
            final_similarity = avg_similarity * (1 + confidence_boost)
            
            # –ü—Ä—è–º–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ü–≤–µ—Ç–æ–≤—ã—Ö –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–æ–º –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º
            try:
                # –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Ü–≤–µ—Ç–æ–≤
                query_img = cv2.imread(query_image_path)
                result_img = cv2.imread(path)
                
                if query_img is not None and result_img is not None:
                    # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ HSV –¥–ª—è –ª—É—á—à–µ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Ü–≤–µ—Ç–æ–≤
                    query_hsv = cv2.cvtColor(query_img, cv2.COLOR_BGR2HSV)
                    result_hsv = cv2.cvtColor(result_img, cv2.COLOR_BGR2HSV)
                    
                    # –°–æ–∑–¥–∞–µ–º —Ü–≤–µ—Ç–æ–≤—ã–µ –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º—ã (–æ—Ç—Ç–µ–Ω–æ–∫ –∏ –Ω–∞—Å—ã—â–µ–Ω–Ω–æ—Å—Ç—å)
                    h_bins = 30  # –£–≤–µ–ª–∏—á–µ–Ω–Ω–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –¥–ª—è –æ—Ç—Ç–µ–Ω–∫–∞
                    s_bins = 32  # –ù–∞—Å—ã—â–µ–Ω–Ω–æ—Å—Ç—å 
                    histSize = [h_bins, s_bins]
                    h_ranges = [0, 180]
                    s_ranges = [0, 256]
                    ranges = h_ranges + s_ranges
                    channels = [0, 1]  # H –∏ S –∫–∞–Ω–∞–ª—ã
                    
                    # –í—ã—á–∏—Å–ª—è–µ–º –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º—ã
                    query_hist = cv2.calcHist([query_hsv], channels, None, histSize, ranges)
                    result_hist = cv2.calcHist([result_hsv], channels, None, histSize, ranges)
                    
                    # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º—ã
                    cv2.normalize(query_hist, query_hist, 0, 1, cv2.NORM_MINMAX)
                    cv2.normalize(result_hist, result_hist, 0, 1, cv2.NORM_MINMAX)
                    
                    # –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º—ã (0-1, –≥–¥–µ 1 - –∏–¥–µ–∞–ª—å–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ)
                    color_similarity = cv2.compareHist(query_hist, result_hist, cv2.HISTCMP_CORREL)
                    
                    # –ò–∑–±–µ–≥–∞–µ–º –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
                    color_similarity = max(0, color_similarity)
                    
                    logger.info(f"–¶–≤–µ—Ç–æ–≤–∞—è —Å—Ö–æ–∂–µ—Å—Ç—å –¥–ª—è {os.path.basename(path)}: {color_similarity:.3f}")
                    
                    # –ó–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —É—Å–∏–ª–∏–≤–∞–µ–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –¥–ª—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ —Å –ø–æ—Ö–æ–∂–∏–º —Ü–≤–µ—Ç–æ–º
                    # –≠—Ç–æ —Ä–µ—à–∏—Ç –ø—Ä–æ–±–ª–µ–º—É, –∫–æ–≥–¥–∞ —Å–∏–Ω–∏–π Makita —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —á–µ—Ä–Ω–æ–º—É —à—É—Ä—É–ø–æ–≤–µ—Ä—Ç—É
                    color_boost = 1.0 + (color_similarity * 5.0)  # –î–æ 6x –±—É—Å—Ç –¥–ª—è —Ü–≤–µ—Ç–æ–≤–æ–≥–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è
                    final_similarity *= color_boost
                    
                    logger.info(f"–¶–≤–µ—Ç–æ–≤–æ–π –±—É—Å—Ç –¥–ª—è {os.path.basename(path)}: {color_boost:.2f}x")
            except Exception as e:
                logger.warning(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏–∏ —Ü–≤–µ—Ç–æ–≤ –¥–ª—è {path}: {e}")
            
            # –û—á–µ–Ω—å —Å–∏–ª—å–Ω–æ —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –¥–ª—è —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è —Ç–∏–ø–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ 
            # (—ç—Ç–æ —Å–∞–º—ã–π –≤–∞–∂–Ω—ã–π —Ñ–∞–∫—Ç–æ—Ä - —à—É—Ä—É–ø–æ–≤–µ—Ä—Ç –¥–æ–ª–∂–µ–Ω —Å–æ–ø–æ—Å—Ç–∞–≤–ª—è—Ç—å—Å—è —Å —à—É—Ä—É–ø–æ–≤–µ—Ä—Ç–æ–º)
            if query_tool_type == result_tool_type and query_tool_type != "unknown":
                # –ï—Å–ª–∏ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Ç–∏–ø –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ - –æ—á–µ–Ω—å —Å–∏–ª—å–Ω–æ –ø–æ–≤—ã—à–∞–µ–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
                type_match_boost = 8.0  # –£–º–Ω–æ–∂–∞–µ–º –≤ 8 —Ä–∞–∑ –¥–ª—è —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è —Ç–∏–ø–∞
                final_similarity *= type_match_boost
                logger.info(f"–°–∏–ª—å–Ω–æ–µ –ø–æ–≤—ã—à–µ–Ω–∏–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞ –¥–ª—è {path} - —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Ç–∏–ø–∞ {query_tool_type_ru}")
            elif query_tool_type != "unknown" and result_tool_type != "unknown" and query_tool_type != result_tool_type:
                # –ï—Å–ª–∏ —Ç–∏–ø—ã –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç - —Å–∏–ª—å–Ω–æ –ø–æ–Ω–∏–∂–∞–µ–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
                final_similarity *= 0.05  # –ü–æ–Ω–∏–∂–∞–µ–º –¥–æ 5% –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤
                logger.info(f"–°–∏–ª—å–Ω–æ–µ –ø–æ–Ω–∏–∂–µ–Ω–∏–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞ –¥–ª—è {path} - —Ä–∞–∑–Ω—ã–µ —Ç–∏–ø—ã {query_tool_type_ru} –∏ {result_tool_type_ru}")
                
            # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –¥–ª—è —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –±—Ä–µ–Ω–¥–∞
            if query_brand and result_brand and query_brand == result_brand:
                # –î–ª—è —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –±—Ä–µ–Ω–¥–∞ —Ç–æ–∂–µ —Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
                brand_match_boost = 3.0  # –£–º–Ω–æ–∂–∞–µ–º –≤ 3 —Ä–∞–∑–∞ –¥–ª—è —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –±—Ä–µ–Ω–¥–∞
                final_similarity *= brand_match_boost
                logger.info(f"–ü–æ–≤—ã—à–µ–Ω–∏–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞ –¥–ª—è {path} - —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –±—Ä–µ–Ω–¥–∞ {query_brand}")
            elif query_brand and result_brand and query_brand != result_brand:
                # –î–ª—è —Ä–∞–∑–Ω—ã—Ö –±—Ä–µ–Ω–¥–æ–≤ –ø–æ–Ω–∏–∂–∞–µ–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
                final_similarity *= 0.2
                logger.info(f"–ü–æ–Ω–∏–∂–µ–Ω–∏–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞ –¥–ª—è {path} - —Ä–∞–∑–Ω—ã–µ –±—Ä–µ–Ω–¥—ã {query_brand} –∏ {result_brand}")
            
            # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Å—Ö–æ–∂–µ—Å—Ç–∏ –º–∞–∫—Å–∏–º—É–º–æ–º 1.0
            final_similarity = min(final_similarity, 1.0)
            
            weighted_results.append((path, final_similarity))
        
        # –°–æ—Ä—Ç–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ —Å—Ö–æ–∂–µ—Å—Ç–∏
        weighted_results.sort(key=lambda x: x[1], reverse=True)
        
        # –ë–µ—Ä–µ–º —Ç–æ–ª—å–∫–æ top_n —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        final_results = weighted_results[:top_n]
        
        # –õ–æ–≥–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        logger.info(f"–£–ª—É—á—à–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫: –Ω–∞–π–¥–µ–Ω–æ {len(final_results)} —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏–∑ {len(combined_results)} –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤")
        for i, (path, sim) in enumerate(final_results):
            logger.info(f"–†–µ–∑—É–ª—å—Ç–∞—Ç #{i+1}: {os.path.basename(path)}, —Å—Ö–æ–∂–µ—Å—Ç—å {sim:.3f}")
        
        # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
        for file_path in variation_files:
            try:
                if os.path.exists(file_path):
                    os.remove(file_path)
            except Exception as e:
                logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª {file_path}: {e}")
        
        return final_results
        
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ enhanced_image_search: {e}")
        import traceback
        logger.error(f"–î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏: {traceback.format_exc()}")
        
        # –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –±–∞–∑–æ–≤—ã–π –ø–æ–∏—Å–∫
        logger.info("–í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ –±–∞–∑–æ–≤–æ–º—É –ø–æ–∏—Å–∫—É –∏–∑-–∑–∞ –æ—à–∏–±–∫–∏")
        return find_similar_images(query_image_path, top_n=top_n, similarity_threshold=similarity_threshold)

async def photo_search_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ —Ñ–æ—Ç–æ —Å –≤—ã–±–æ—Ä–æ–º –æ—Ç–¥–µ–ª–∞"""
    user_id = update.effective_user.id

    # –õ–æ–≥–∏—Ä—É–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã
    analytics = context.bot_data.get('analytics')
    if analytics:
        analytics.log_command("photo_search", user_id)

    # –û—Ç–∫–ª—é—á–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ä–µ–∂–∏–º –æ–∂–∏–¥–∞–Ω–∏—è —Ñ–æ—Ç–æ, –µ—Å–ª–∏ –±—ã–ª –∞–∫—Ç–∏–≤–µ–Ω
    context.user_data["awaiting_photo"] = False
    
    # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –æ—Ç–¥–µ–ª–∞–º–∏
    keyboard = [
        ["üé® –ö—Ä–∞—Å–∫–∞", "üß± –°—Ç—Ä–æ–π–∫–∞"],
        ["ü™ë –°—Ç–æ–ª—è—Ä–∫–∞", "‚ö° –≠–ª–µ–∫—Ç—Ä–∏–∫–∞"],
        ["üî® –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã", "üöø –í–æ–¥–æ—Å–Ω–∞–±–∂–µ–Ω–∏–µ"],
        ["üå± –°–∞–¥", "üîß –°–∫–æ–±—è–Ω–∫–∞"],
        ["üîô –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é"]
    ]
    reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)
    
    await update.message.reply_text(
        "üì∏ *–ü–æ–∏—Å–∫ –ø–æ —Ñ–æ—Ç–æ*\n\n"
        "–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–¥–µ–ª, –≤ –∫–æ—Ç–æ—Ä–æ–º —Ö–æ—Ç–∏—Ç–µ –∏—Å–∫–∞—Ç—å —Ç–æ–≤–∞—Ä:\n"
        "‚Ä¢ üé® –ö—Ä–∞—Å–∫–∞ - –∫—Ä–∞—Å–∫–∏, —ç–º–∞–ª–∏, –ª–∞–∫–∏\n"
        "‚Ä¢ üß± –°—Ç—Ä–æ–π–∫–∞ - —Ü–µ–º–µ–Ω—Ç, –≥–∏–ø—Å, —à—Ç—É–∫–∞—Ç—É—Ä–∫–∞\n"
        "‚Ä¢ ü™ë –°—Ç–æ–ª—è—Ä–∫–∞ - –¥–µ—Ä–µ–≤–æ–æ–±—Ä–∞–±–æ—Ç–∫–∞, —Ñ–∞–Ω–µ—Ä–∞\n"
        "‚Ä¢ ‚ö° –≠–ª–µ–∫—Ç—Ä–∏–∫–∞ - —Ä–æ–∑–µ—Ç–∫–∏, –ø—Ä–æ–≤–æ–¥–∞, –≤—ã–∫–ª—é—á–∞—Ç–µ–ª–∏\n"
        "‚Ä¢ üî® –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã - –≤—Å–µ –≤–∏–¥—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤\n"
        "‚Ä¢ üöø –í–æ–¥–æ—Å–Ω–∞–±–∂–µ–Ω–∏–µ - —Ç—Ä—É–±—ã, –∫—Ä–∞–Ω—ã, —Ñ–∏—Ç–∏–Ω–≥–∏\n"
        "‚Ä¢ üå± –°–∞–¥ - —Ç–æ–≤–∞—Ä—ã –¥–ª—è —Å–∞–¥–∞ –∏ –æ–≥–æ—Ä–æ–¥–∞\n"
        "‚Ä¢ üîß –°–∫–æ–±—è–Ω–∫–∞ - –º–µ—Ç–∏–∑—ã, –∫—Ä–µ–ø–µ–∂–∏, —Ñ—É—Ä–Ω–∏—Ç—É—Ä–∞\n\n"
        "üí° –í—ã–±–æ—Ä –æ—Ç–¥–µ–ª–∞ –ø–æ–º–æ–∂–µ—Ç –ø–æ–ª—É—á–∏—Ç—å –±–æ–ª–µ–µ —Ç–æ—á–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã",
        reply_markup=reply_markup,
        parse_mode='Markdown'
    )

async def department_selection_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ –æ—Ç–¥–µ–ª–∞ –ø–µ—Ä–µ–¥ –ø–æ–∏—Å–∫–æ–º –ø–æ —Ñ–æ—Ç–æ"""
    user_id = update.effective_user.id
    selected_department = update.message.text
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –æ—Ç–¥–µ–ª –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    context.user_data["selected_department"] = selected_department
    
    # –í–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º –æ–∂–∏–¥–∞–Ω–∏—è —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏
    context.user_data["awaiting_photo"] = True
    
    # –ü–æ–ª—É—á–∞–µ–º —ç–º–æ–¥–∑–∏ –æ—Ç–¥–µ–ª–∞
    department_emoji = selected_department.split()[0]
    
    # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è –æ—Ç–º–µ–Ω—ã
    keyboard = [["üîô –ù–∞–∑–∞–¥ –∫ –≤—ã–±–æ—Ä—É –æ—Ç–¥–µ–ª–∞"], ["üîô –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é"]]
    reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)
    
    # –õ–æ–≥–∏—Ä—É–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –æ—Ç–¥–µ–ª–∞
    analytics = context.bot_data.get('analytics')
    if analytics:
        analytics.log_command(f"photo_search_{selected_department}", user_id)
    
    await update.message.reply_text(
        f"{department_emoji} *–ü–æ–∏—Å–∫ –≤ –æ—Ç–¥–µ–ª–µ {selected_department}*\n\n"
        f"–¢–µ–ø–µ—Ä—å –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é —Ç–æ–≤–∞—Ä–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞.\n\n"
        f"üí° –°–æ–≤–µ—Ç—ã –¥–ª—è –ª—É—á—à–µ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:\n"
        f"‚Ä¢ –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä—É–π—Ç–µ –≤ —Ö–æ—Ä–æ—à–µ–º –æ—Å–≤–µ—â–µ–Ω–∏–∏\n"
        f"‚Ä¢ –î–µ—Ä–∂–∏—Ç–µ –∫–∞–º–µ—Ä—É –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Ç–æ–≤–∞—Ä—É\n"
        f"‚Ä¢ –ò–∑–±–µ–≥–∞–π—Ç–µ —Ç–µ–Ω–µ–π –∏ –æ—Ç—Ä–∞–∂–µ–Ω–∏–π\n"
        f"‚Ä¢ –°–ª–µ–¥–∏—Ç–µ, —á—Ç–æ–±—ã —Ç–æ–≤–∞—Ä –∑–∞–Ω–∏–º–∞–ª –±–æ–ª—å—à—É—é —á–∞—Å—Ç—å –∫–∞–¥—Ä–∞",
        reply_markup=reply_markup,
        parse_mode='Markdown'
    )

async def back_to_departments_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–æ–∑–≤—Ä–∞—Ç–∞ –∫ –≤—ã–±–æ—Ä—É –æ—Ç–¥–µ–ª–∞"""
    # –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
    context.user_data["awaiting_photo"] = False
    
    # –í—ã–∑—ã–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–∏—Å–∫–∞ –ø–æ —Ñ–æ—Ç–æ –¥–ª—è –ø–æ–∫–∞–∑–∞ –º–µ–Ω—é –æ—Ç–¥–µ–ª–æ–≤
    await photo_search_handler(update, context)

async def show_error_message(update: Update, error_type="general"):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞"""
    error_messages = {
        "access_denied": "‚õî *–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω*\n\n–í—ã –Ω–µ –∏–º–µ–µ—Ç–µ –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–º—É –±–æ—Ç—É.\n–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.",
        "invalid_command": "‚ùå *–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞*\n\n–í–≤–µ–¥–µ–Ω–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞ –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–∞.\n–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–µ–Ω—é –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏.",
        "general": "‚ùå *–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞*\n\n–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É."
    }
    
    message = error_messages.get(error_type, error_messages["general"])
    
    await update.message.reply_text(
        message,
        parse_mode='Markdown'
    )

async def help_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã –ø–æ–º–æ—â–∏"""
    user_id = update.effective_user.id
    
    # –õ–æ–≥–∏—Ä—É–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã
    analytics = context.bot_data.get('analytics')
    if analytics:
        analytics.log_command("help", user_id)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –±–µ–ª–æ–º —Å–ø–∏—Å–∫–µ
    if not is_allowed_user(user_id):
        await show_error_message(update, "access_denied")
        return
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç —Å–ø—Ä–∞–≤–∫–∏
    help_text = (
        "*‚ùì –°–ü–†–ê–í–û–ß–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø –ü–û –ë–û–¢–£*\n\n"
        "*–û –ë–û–¢–ï:*\n"
        "–î–∞–Ω–Ω—ã–π Telegram-–±–æ—Ç —Ä–∞–∑—Ä–∞–±–æ—Ç–∞–Ω –¥–ª—è —É–ø—Ä–æ—â–µ–Ω–∏—è –ø–æ–∏—Å–∫–∞ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤ –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤. "
        "–° –µ–≥–æ –ø–æ–º–æ—â—å—é –≤—ã –º–æ–∂–µ—Ç–µ –Ω–∞–π—Ç–∏ –Ω—É–∂–Ω—ã–π —Ç–æ–≤–∞—Ä –ø–æ —Ñ–æ—Ç–æ, –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–∞–≥–∞–∑–∏–Ω–∞—Ö, "
        "–æ–∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è —Å –∫–∞—Ç–∞–ª–æ–≥–æ–º —Å–∫–æ–±—è–Ω—ã—Ö –∏–∑–¥–µ–ª–∏–π –∏ –º–Ω–æ–≥–æ–µ –¥—Ä—É–≥–æ–µ.\n\n"
        
        "*–û–°–ù–û–í–ù–´–ï –ö–û–ú–ê–ù–î–´:*\n"
        "‚Ä¢ /start - –∑–∞–ø—É—Å–∫ –±–æ—Ç–∞ –∏ –≤–æ–∑–≤—Ä–∞—Ç –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é\n"
        "‚Ä¢ /help - –≤—ã–∑–æ–≤ —ç—Ç–æ–π —Å–ø—Ä–∞–≤–∫–∏\n"
        "‚Ä¢ /stop - –æ—Ç–º–µ–Ω–∞ —Ç–µ–∫—É—â–µ–π –æ–ø–µ—Ä–∞—Ü–∏–∏\n\n"
        
        "*–û–°–ù–û–í–ù–´–ï –†–ê–ó–î–ï–õ–´:*\n"
        "‚Ä¢ üìû *–ö–æ–Ω—Ç–∞–∫—Ç—ã* - –¥–æ—Å—Ç—É–ø –∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –º–∞–≥–∞–∑–∏–Ω–∞—Ö, –ª–æ–≥–∏—Å—Ç–∏–∫–µ –∏ –¥—Ä—É–≥–∏–º –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–º –¥–∞–Ω–Ω—ã–º\n"
        "‚Ä¢ üì∏ *–ü–æ–∏—Å–∫ –ø–æ —Ñ–æ—Ç–æ* - –ø–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤ —Å –ø–æ–º–æ—â—å—é —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏\n"
        "‚Ä¢ ‚ùì *–ü–æ–º–æ—â—å* - –¥–∞–Ω–Ω–∞—è —Å–ø—Ä–∞–≤–∫–∞\n\n"
        
        "*–†–ê–ó–î–ï–õ –ö–û–ù–¢–ê–ö–¢–´:*\n"
        "‚Ä¢ üè™ *–ú–∞–≥–∞–∑–∏–Ω—ã* - –∞–¥—Ä–µ—Å–∞ –∏ –∫–æ–Ω—Ç–∞–∫—Ç—ã –º–∞–≥–∞–∑–∏–Ω–æ–≤\n"
        "‚Ä¢ üöö *–õ–æ–≥–∏—Å—Ç–∏–∫–∞* - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–æ—Å—Ç–∞–≤–∫–µ –∏ –ø–µ—Ä–µ–≤–æ–∑–∫–∞—Ö\n"
        "‚Ä¢ üó∫ *–ö–∞—Ä—Ç—ã* - —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–≤ –Ω–∞ –∫–∞—Ä—Ç–µ\n"
        "‚Ä¢ üîß *–°–∫–æ–±—è–Ω–∫–∞* - —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –ø–æ —Å–∫–æ–±—è–Ω—ã–º –∏–∑–¥–µ–ª–∏—è–º\n\n"
        
        "*–ü–û–ò–°–ö –ü–û –§–û–¢–û:*\n"
        "–≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –ø–æ–∑–≤–æ–ª—è–µ—Ç –∏—Å–∫–∞—Ç—å —Ç–æ–≤–∞—Ä—ã, —Å—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä–æ–≤–∞–≤ –∏—Ö. –î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:\n"
        "1. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É üì∏ *–ü–æ–∏—Å–∫ –ø–æ —Ñ–æ—Ç–æ*\n"
        "2. –í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–¥–µ–ª, –≤ –∫–æ—Ç–æ—Ä–æ–º –Ω—É–∂–Ω–æ –∏—Å–∫–∞—Ç—å —Ç–æ–≤–∞—Ä\n"
        "3. –°–¥–µ–ª–∞–π—Ç–µ —á–µ—Ç–∫—É—é —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é —Ç–æ–≤–∞—Ä–∞ –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –±–æ—Ç—É\n"
        "4. –î–æ–∂–¥–∏—Ç–µ—Å—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞\n\n"
        
        "*–°–û–í–ï–¢–´ –ü–û –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Æ:*\n"
        "‚Ä¢ –î–ª—è –ª—É—á—à–µ–≥–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –¥–µ–ª–∞–π—Ç–µ —Ñ–æ—Ç–æ –ø—Ä–∏ —Ö–æ—Ä–æ—à–µ–º –æ—Å–≤–µ—â–µ–Ω–∏–∏\n"
        "‚Ä¢ –°—Ç–∞—Ä–∞–π—Ç–µ—Å—å –¥–µ—Ä–∂–∞—Ç—å –∫–∞–º–µ—Ä—É –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Ç–æ–≤–∞—Ä—É\n"
        "‚Ä¢ –ò–∑–±–µ–≥–∞–π—Ç–µ —Ç–µ–Ω–µ–π –∏ –±–ª–∏–∫–æ–≤ –Ω–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏\n"
        "‚Ä¢ –ï—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç–µ –Ω—É–∂–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–æ–π –æ—Ç–¥–µ–ª –∏–ª–∏ —Å–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ —Å –¥—Ä—É–≥–æ–≥–æ —Ä–∞–∫—É—Ä—Å–∞\n\n"
        
        "*–ù–ê–í–ò–ì–ê–¶–ò–Ø:*\n"
        "‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –Ω–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–µ –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ –º–µ–∂–¥—É —Ä–∞–∑–¥–µ–ª–∞–º–∏\n"
        "‚Ä¢ –ö–Ω–æ–ø–∫–∞ üîô *–ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é* –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –∏–∑ –ª—é–±–æ–≥–æ —Ä–∞–∑–¥–µ–ª–∞\n"
        "‚Ä¢ –ö–æ–º–∞–Ω–¥–∞ /stop –æ—Ç–º–µ–Ω—è–µ—Ç —Ç–µ–∫—É—â—É—é –æ–ø–µ—Ä–∞—Ü–∏—é\n\n"
        
        "üí° –ü–æ –ª—é–±—ã–º –≤–æ–ø—Ä–æ—Å–∞–º –∏ –ø—Ä–æ–±–ª–µ–º–∞–º –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É."
    )
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø—Ä–∞–≤–∫—É
    await update.message.reply_text(
        help_text,
        parse_mode='Markdown',
        reply_markup=ReplyKeyboardMarkup([["üîô –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é"]], resize_keyboard=True)
    )

async def stop_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /stop - –æ—Ç–º–µ–Ω—è–µ—Ç —Ç–µ–∫—É—â—É—é –æ–ø–µ—Ä–∞—Ü–∏—é"""
    user_id = update.effective_user.id
    
    # –õ–æ–≥–∏—Ä—É–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã
    analytics = context.bot_data.get('analytics')
    if analytics:
        analytics.log_command("stop", user_id)
    
    # –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    if 'state' in context.user_data:
        del context.user_data['state']
    
    if 'awaiting_photo' in context.user_data:
        context.user_data['awaiting_photo'] = False
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
    await update.message.reply_text(
        "‚úÖ –¢–µ–∫—É—â–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞. –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é.",
        reply_markup=ReplyKeyboardMarkup([
            ["üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã", "üì∏ –ü–æ–∏—Å–∫ –ø–æ —Ñ–æ—Ç–æ"],
            ["‚ùì –ü–æ–º–æ—â—å"]
        ], resize_keyboard=True)
    )

async def get_stats_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /stats - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –±–æ—Ç–∞"""
    user_id = update.effective_user.id
    config = load_config()
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–æ–º
    if user_id not in config.get('admins', []):
        await update.message.reply_text("‚õî –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω")
        return
    
    # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    analytics = context.bot_data.get('analytics')
    if not analytics:
        await update.message.reply_text("‚ùå –°–∏—Å—Ç–µ–º–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞")
        return
    
    # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∫–æ–º–∞–Ω–¥
    command_stats = analytics.get_command_stats()
    
    if not command_stats:
        await update.message.reply_text("üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–∫–∞ –Ω–µ —Å–æ–±—Ä–∞–Ω–∞")
        return
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π
    stats_message = "*üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –±–æ—Ç–∞*\n\n"
    
    for command, count in command_stats:
        stats_message += f"‚Ä¢ {command}: {count} —Ä–∞–∑\n"
    
    await update.message.reply_text(
        stats_message,
        parse_mode='Markdown'
    )

async def contacts_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Ä–∞–∑–¥–µ–ª–∞ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤"""
    user_id = update.effective_user.id
    
    if not is_allowed_user(user_id):
        await show_error_message(update, "access_denied")
        return
    
    # –õ–æ–≥–∏—Ä—É–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã
    analytics = context.bot_data.get('analytics')
    if analytics:
        analytics.log_command("contacts", user_id)
    
    # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è —Ä–∞–∑–¥–µ–ª–∞ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤
    keyboard = [
        ["üè™ –ú–∞–≥–∞–∑–∏–Ω—ã"],
        ["üó∫ –ö–∞—Ä—Ç—ã", "üîß –°–∫–æ–±—è–Ω–∫–∞"],
        ["üîô –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é"]
    ]
    reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –º–µ–Ω—é
    await update.message.reply_text(
        "*üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è*\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ –Ω—É–∂–Ω—ã–π —Ä–∞–∑–¥–µ–ª:\n"
        "‚Ä¢ üè™ –ú–∞–≥–∞–∑–∏–Ω—ã - –∞–¥—Ä–µ—Å–∞ –∏ —Ç–µ–ª–µ—Ñ–æ–Ω—ã –º–∞–≥–∞–∑–∏–Ω–æ–≤\n"
        "‚Ä¢ üó∫ –ö–∞—Ä—Ç—ã - —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–≤ –Ω–∞ –∫–∞—Ä—Ç–µ\n"
        "‚Ä¢ üîß –°–∫–æ–±—è–Ω–∫–∞ - –∫–∞—Ç–∞–ª–æ–≥ —Å–∫–æ–±—è–Ω—ã—Ö –∏–∑–¥–µ–ª–∏–π\n\n"
        "üí° _–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏_",
        reply_markup=reply_markup,
        parse_mode='Markdown'
    )

async def products_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Ä–∞–∑–¥–µ–ª–∞ —Ç–æ–≤–∞—Ä–æ–≤"""
    user_id = update.effective_user.id
    
    if not is_allowed_user(user_id):
        await show_error_message(update, "access_denied")
        return
    
    # –õ–æ–≥–∏—Ä—É–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã
    analytics = context.bot_data.get('analytics')
    if analytics:
        analytics.log_command("products", user_id)
    
    # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è —Ä–∞–∑–¥–µ–ª–∞ —Ç–æ–≤–∞—Ä–æ–≤
    keyboard = [
        ["üé® –¶–≤–µ—Ç–∞", "üîß –°–∫–æ–±—è–Ω–∫–∞"],
        ["üîô –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é"]
    ]
    reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –º–µ–Ω—é
    await update.message.reply_text(
        "*üì¶ –¢–æ–≤–∞—Ä—ã*\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ –Ω—É–∂–Ω—ã–π —Ä–∞–∑–¥–µ–ª:\n"
        "‚Ä¢ üé® –¶–≤–µ—Ç–∞ - –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Ü–≤–µ—Ç–æ–≤\n"
        "‚Ä¢ üîß –°–∫–æ–±—è–Ω–∫–∞ - –∫–∞—Ç–∞–ª–æ–≥ —Å–∫–æ–±—è–Ω—ã—Ö –∏–∑–¥–µ–ª–∏–π\n\n"
        "üí° _–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏_",
        reply_markup=reply_markup,
        parse_mode='Markdown'
    )

async def documents_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Ä–∞–∑–¥–µ–ª–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤"""
    user_id = update.effective_user.id
    
    if not is_allowed_user(user_id):
        await show_error_message(update, "access_denied")
        return
    
    # –õ–æ–≥–∏—Ä—É–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã
    analytics = context.bot_data.get('analytics')
    if analytics:
        analytics.log_command("documents", user_id)
    
    # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è —Ä–∞–∑–¥–µ–ª–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
    keyboard = [
        ["üìÑ –ï–ì–ê–ò–°"],
        ["üîô –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é"]
    ]
    reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –º–µ–Ω—é
    await update.message.reply_text(
        "*üìÑ –î–æ–∫—É–º–µ–Ω—Ç—ã*\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ –Ω—É–∂–Ω—ã–π —Ä–∞–∑–¥–µ–ª:\n"
        "‚Ä¢ üìÑ –ï–ì–ê–ò–° - –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –ï–ì–ê–ò–°\n\n"
        "üí° _–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤_",
        reply_markup=reply_markup,
        parse_mode='Markdown'
    )

async def stores_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Ä–∞–∑–¥–µ–ª–∞ –º–∞–≥–∞–∑–∏–Ω–æ–≤"""
    user_id = update.effective_user.id
    
    if not is_allowed_user(user_id):
        await show_error_message(update, "access_denied")
        return
    
    # –õ–æ–≥–∏—Ä—É–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã
    analytics = context.bot_data.get('analytics')
    if analytics:
        analytics.log_command("stores", user_id)
    
    # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Ç–æ–ª—å–∫–æ –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞
    keyboard = [["üîô –ù–∞–∑–∞–¥ –≤ –∫–æ–Ω—Ç–∞–∫—Ç—ã"]]
    reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)
    
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–∏—Å–∫–∞ –º–∞–≥–∞–∑–∏–Ω–æ–≤
    context.user_data['state'] = 'searching_stores'
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–µ–π –ø–æ –ø–æ–∏—Å–∫—É
    await update.message.reply_text(
        "*üè™ –ü–æ–∏—Å–∫ –ø–æ —Ç–∞–±–ª–∏—Ü–µ*\n\n"
        "–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∏–ª–∏ –æ—Ç–¥–µ–ª –¥–ª—è –ø–æ–∏—Å–∫–∞.\n"
        "–ü–æ–∏—Å–∫ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–æ —á–∞—Å—Ç–∏—á–Ω–æ–º—É —Å–æ–≤–ø–∞–¥–µ–Ω–∏—é —Ç–µ–∫—Å—Ç–∞.\n\n"
        "üí° _–ü—Ä–∏–º–µ—Ä: –∏—Å–ø_",
        reply_markup=reply_markup,
        parse_mode='Markdown'
    )

async def maps_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Ä–∞–∑–¥–µ–ª–∞ –∫–∞—Ä—Ç"""
    user_id = update.effective_user.id
    
    if not is_allowed_user(user_id):
        await show_error_message(update, "access_denied")
        return
    
    # –õ–æ–≥–∏—Ä—É–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã
    analytics = context.bot_data.get('analytics')
    if analytics:
        analytics.log_command("maps", user_id)
    
    # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞
    keyboard = [["üîô –ù–∞–∑–∞–¥ –≤ –∫–æ–Ω—Ç–∞–∫—Ç—ã"]]
    reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
    await update.message.reply_text(
        "*üó∫ –ö–∞—Ä—Ç—ã*\n\n"
        "–í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ. –°–∫–æ—Ä–æ –∑–¥–µ—Å—å –ø–æ—è–≤—è—Ç—Å—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ –∫–∞—Ä—Ç—ã —Å —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ–º –º–∞–≥–∞–∑–∏–Ω–æ–≤ –∏ —Å–∫–ª–∞–¥–æ–≤.",
        reply_markup=reply_markup,
        parse_mode='Markdown'
    )

async def logistics_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Ä–∞–∑–¥–µ–ª–∞ –ª–æ–≥–∏—Å—Ç–∏–∫–∏"""
    user_id = update.effective_user.id
    
    if not is_allowed_user(user_id):
        await show_error_message(update, "access_denied")
        return
    
    # –õ–æ–≥–∏—Ä—É–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã
    analytics = context.bot_data.get('analytics')
    if analytics:
        analytics.log_command("logistics", user_id)
    
    # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞
    keyboard = [["üîô –ù–∞–∑–∞–¥ –≤ –∫–æ–Ω—Ç–∞–∫—Ç—ã"]]
    reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
    await update.message.reply_text(
        "*üöö –õ–æ–≥–∏—Å—Ç–∏–∫–∞*\n\n"
        "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–æ—Å—Ç–∞–≤–∫–µ —Ç–æ–≤–∞—Ä–æ–≤:\n\n"
        "‚Ä¢ –î–æ—Å—Ç–∞–≤–∫–∞ –æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç—Å—è –≤ —Ç–µ—á–µ–Ω–∏–µ 1-3 —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π\n"
        "‚Ä¢ –°—Ç–æ–∏–º–æ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –≤–µ—Å–∞ –∏ –≥–∞–±–∞—Ä–∏—Ç–æ–≤ –∑–∞–∫–∞–∑–∞\n"
        "‚Ä¢ –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏ - 300 —Ä—É–±.\n\n"
        "–î–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è —Å—Ä–æ–∫–æ–≤ –∏ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –º–µ–Ω–µ–¥–∂–µ—Ä—É.",
        reply_markup=reply_markup,
        parse_mode='Markdown'
    )

async def skobyanka_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Ä–∞–∑–¥–µ–ª–∞ —Å–∫–æ–±—è–Ω–∫–∏"""
    user_id = update.effective_user.id
    
    if not is_allowed_user(user_id):
        await show_error_message(update, "access_denied")
        return
    
    # –õ–æ–≥–∏—Ä—É–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã
    analytics = context.bot_data.get('analytics')
    if analytics:
        analytics.log_command("skobyanka", user_id)
    
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–∏—Å–∫–∞ —Å–∫–æ–±—è–Ω–∫–∏
    context.user_data['state'] = 'searching_skobyanka'
    
    # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞
    keyboard = [["üîô –ù–∞–∑–∞–¥ –≤ –∫–æ–Ω—Ç–∞–∫—Ç—ã"], ["üîô –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é"]]
    reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
    await update.message.reply_text(
        "*üîß –ö–∞—Ç–∞–ª–æ–≥ —Å–∫–æ–±—è–Ω—ã—Ö –∏–∑–¥–µ–ª–∏–π*\n\n"
        "–í–≤–µ–¥–∏—Ç–µ –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–∏—Å–∫–∞ –≤ –∫–∞—Ç–∞–ª–æ–≥–µ —Å–∫–æ–±—è–Ω—ã—Ö –∏–∑–¥–µ–ª–∏–π.\n"
        "–ü–æ–∏—Å–∫ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–æ —á–∞—Å—Ç–∏—á–Ω–æ–º—É —Å–æ–≤–ø–∞–¥–µ–Ω–∏—é —Ç–µ–∫—Å—Ç–∞.\n"
        "–ú–æ–∂–Ω–æ –∏—Å–∫–∞—Ç—å –ø–æ:\n"
        "‚Ä¢ –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏—é\n"
        "‚Ä¢ –ê—Ä—Ç–∏–∫—É–ª—É\n"
        "‚Ä¢ –†–∞–∑–º–µ—Ä—É\n"
        "‚Ä¢ –î—Ä—É–≥–∏–º –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º\n\n"
        "üí° _–ü—Ä–∏–º–µ—Ä: –≤–∏–Ω—Ç 5_",
        reply_markup=reply_markup,
        parse_mode='Markdown'
    )

async def back_to_menu_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"""
    user_id = update.effective_user.id
    
    # –õ–æ–≥–∏—Ä—É–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã
    analytics = context.bot_data.get('analytics')
    if analytics:
        analytics.log_command("back_to_menu", user_id)
    
    # –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
    if 'state' in context.user_data:
        del context.user_data['state']
    if 'awaiting_photo' in context.user_data:
        context.user_data['awaiting_photo'] = False
    if 'selected_department' in context.user_data:
        del context.user_data['selected_department']
    
    # –í—ã–∑—ã–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start –¥–ª—è –ø–æ–∫–∞–∑–∞ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é
    await start(update, context)

async def back_to_products_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ —Ä–∞–∑–¥–µ–ª —Ç–æ–≤–∞—Ä–æ–≤"""
    await products_handler(update, context)

async def text_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π"""
    user_id = update.effective_user.id
    text = update.message.text
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –±–µ–ª–æ–º —Å–ø–∏—Å–∫–µ
    if not is_allowed_user(user_id):
        await show_error_message(update, "access_denied")
        return
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    state = context.user_data.get('state')
    
    # –õ–æ–≥–∏—Ä—É–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø–æ–∏—Å–∫–∞
    analytics = context.bot_data.get('analytics')
    if analytics:
        analytics.log_command("text_search", user_id)
    
    if state == 'searching_colors':
        # –ü–æ–∏—Å–∫ —Ü–≤–µ—Ç–æ–≤ (–∫–æ–¥ –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è)
        config = load_config()
        colors_file = config.get('colors_file')
        
        if not colors_file or not os.path.exists(colors_file):
            await update.message.reply_text("‚ùå –§–∞–π–ª —Å –±–∞–∑–æ–π —Ü–≤–µ—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω")
            return
        
        results = await search_in_colors(text, colors_file, context)
        
        if results:
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞–π–¥–µ–Ω–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
            for i, result in enumerate(results[:10]):  # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–æ 10 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
                await update.message.reply_text(
                    result,
                    parse_mode='Markdown'
                )
                
            if len(results) > 10:
                await update.message.reply_text(
                    f"üîç –ù–∞–π–¥–µ–Ω–æ –µ—â—ë {len(results) - 10} —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤. –£—Ç–æ—á–Ω–∏—Ç–µ –∑–∞–ø—Ä–æ—Å –¥–ª—è –±–æ–ª–µ–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤."
                )
        else:
            await update.message.reply_text(
                "‚ùå –ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π –∑–∞–ø—Ä–æ—Å."
            )
    
    elif state == 'searching_stores':
        # –ü–æ–∏—Å–∫ –≤ —Ç–∞–±–ª–∏—Ü–µ table_2.xlsx
        results = await search_in_table2(text, context)
        
        if results:
            await update.message.reply_text(
                f"*üè™ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –ø–æ –∑–∞–ø—Ä–æ—Å—É:* '{text}'\n",
                parse_mode='Markdown'
            )
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞–π–¥–µ–Ω–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
            for i, result in enumerate(results[:10]):  # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–æ 10 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
                await update.message.reply_text(
                    result,
                    parse_mode='Markdown'
                )
                
            if len(results) > 10:
                await update.message.reply_text(
                    f"üîç –ù–∞–π–¥–µ–Ω–æ –µ—â—ë {len(results) - 10} —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤. –£—Ç–æ—á–Ω–∏—Ç–µ –∑–∞–ø—Ä–æ—Å –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤."
                )
        else:
            await update.message.reply_text(
                "‚ùå –ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å."
            )
    
    elif state == 'searching_skobyanka':
        # –ü–æ–∏—Å–∫ –≤ –∫–∞—Ç–∞–ª–æ–≥–µ —Å–∫–æ–±—è–Ω–∫–∏ —Å –ø—Ä—è–º—ã–º —É–∫–∞–∑–∞–Ω–∏–µ–º —Ñ–∞–π–ª–∞
        results = await search_in_skobyanka_direct(text, context)
        
        if results:
            await update.message.reply_text(
                f"*üîß –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –≤ —Å–∫–æ–±—è–Ω–∫–µ –ø–æ –∑–∞–ø—Ä–æ—Å—É:* '{text}'\n",
                parse_mode='Markdown'
            )
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞–π–¥–µ–Ω–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
            for i, result in enumerate(results[:10]):  # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–æ 10 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
                await update.message.reply_text(
                    result,
                    parse_mode='Markdown'
                )
                
            if len(results) > 10:
                await update.message.reply_text(
                    f"üîç –ù–∞–π–¥–µ–Ω–æ –µ—â—ë {len(results) - 10} —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤. –£—Ç–æ—á–Ω–∏—Ç–µ –∑–∞–ø—Ä–æ—Å –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤."
                )
        else:
            await update.message.reply_text(
                "‚ùå –ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å."
            )
    
    elif state == 'awaiting_new_user_id':
        # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        try:
            new_user_id = int(text.strip())
            config = load_config()
            whitelist = config.get('whitelist', [])
            
            if new_user_id in whitelist:
                await update.message.reply_text("‚ùå –≠—Ç–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω.")
            else:
                # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ whitelist
                whitelist.append(new_user_id)
                config['whitelist'] = whitelist
                
                # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
                with open("key.key", "rb") as key_file:
                    key = key_file.read()
                fernet = Fernet(key)
                encrypted_data = fernet.encrypt(json.dumps(config).encode())
                
                with open("config.encrypted", "wb") as config_file:
                    config_file.write(encrypted_data)
                
                await update.message.reply_text(f"‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å ID {new_user_id} —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω.")
                
                # –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                context.user_data.pop('state', None)
        except ValueError:
            await update.message.reply_text("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç ID. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ–≤–æ–π ID.")
    
    elif state == 'awaiting_remove_user_id':
        # –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        try:
            user_id_to_remove = int(text.strip())
            config = load_config()
            whitelist = config.get('whitelist', [])
            
            if user_id_to_remove not in whitelist:
                await update.message.reply_text("‚ùå –≠—Ç–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–ø–∏—Å–∫–µ.")
            else:
                # –£–¥–∞–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ whitelist
                whitelist.remove(user_id_to_remove)
                config['whitelist'] = whitelist
                
                # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
                with open("key.key", "rb") as key_file:
                    key = key_file.read()
                fernet = Fernet(key)
                encrypted_data = fernet.encrypt(json.dumps(config).encode())
                
                with open("config.encrypted", "wb") as config_file:
                    config_file.write(encrypted_data)
                
                await update.message.reply_text(f"‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å ID {user_id_to_remove} —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω.")
                
                # –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                context.user_data.pop('state', None)
        except ValueError:
            await update.message.reply_text("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç ID. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ–≤–æ–π ID.")
    
    else:
        # –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
        await update.message.reply_text(
            "‚ùì –ù–µ –ø–æ–Ω–∏–º–∞—é –≤–∞—à–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–µ–Ω—é –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏.",
            reply_markup=ReplyKeyboardMarkup([["üîô –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é"]], resize_keyboard=True)
        )

async def add_user_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /add_user –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    user_id = update.effective_user.id
    config = load_config()
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º
    if user_id not in config.get('admins', []):
        await update.message.reply_text("‚õî –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥–µ.")
        return
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤
    if not context.args:
        await update.message.reply_text(
            "‚ùå –ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.\n"
            "–ü—Ä–∏–º–µ—Ä: /add_user 123456789"
        )
        return
    
    try:
        # –ü–æ–ª—É—á–∞–µ–º ID –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        new_user_id = int(context.args[0])
        
        # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        whitelist = config.get('whitelist', [])
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω –ª–∏ —É–∂–µ —ç—Ç–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        if new_user_id in whitelist:
            await update.message.reply_text(f"‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å ID {new_user_id} —É–∂–µ –≤ —Å–ø–∏—Å–∫–µ.")
            return
        
        # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        whitelist.append(new_user_id)
        config['whitelist'] = whitelist
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
        with open("key.key", "rb") as key_file:
            key = key_file.read()
        fernet = Fernet(key)
        encrypted_data = fernet.encrypt(json.dumps(config).encode())
        
        with open("config.encrypted", "wb") as config_file:
            config_file.write(encrypted_data)
        
        await update.message.reply_text(f"‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å ID {new_user_id} —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω.")
        
    except ValueError:
        await update.message.reply_text("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç ID. ID –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º.")
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {e}")
        await update.message.reply_text(f"‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {str(e)}")

class Analytics:
    """–ö–ª–∞—Å—Å –¥–ª—è —Å–±–æ—Ä–∞ –∏ –∞–Ω–∞–ª–∏–∑–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –±–æ—Ç–∞"""
    
    def __init__(self):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏"""
        try:
            self.conn = sqlite3.connect('analytics.db', check_same_thread=False)
            self.cursor = self.conn.cursor()
            
            # –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –¥–ª—è –∫–æ–º–∞–Ω–¥, –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
            self.cursor.execute('''
                CREATE TABLE IF NOT EXISTS commands (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    command TEXT NOT NULL,
                    user_id INTEGER NOT NULL,
                    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP
                )
            ''')
            
            # –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
            self.cursor.execute('''
                CREATE TABLE IF NOT EXISTS users (
                    user_id INTEGER PRIMARY KEY,
                    first_seen TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                    last_seen TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                    command_count INTEGER DEFAULT 1
                )
            ''')
            
            self.conn.commit()
            logger.info("‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞")
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∞–Ω–∞–ª–∏—Ç–∏–∫–∏: {e}")
    
    def log_command(self, command, user_id):
        """–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã"""
        try:
            # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –∫–æ–º–∞–Ω–¥—É
            self.cursor.execute(
                "INSERT INTO commands (command, user_id) VALUES (?, ?)",
                (command, user_id)
            )
            
            # –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
            self.cursor.execute(
                """
                INSERT INTO users (user_id, command_count) 
                VALUES (?, 1)
                ON CONFLICT(user_id) 
                DO UPDATE SET 
                    last_seen = CURRENT_TIMESTAMP,
                    command_count = command_count + 1
                """,
                (user_id,)
            )
            
            self.conn.commit()
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–∏ –∫–æ–º–∞–Ω–¥—ã: {e}")
    
    def get_command_stats(self):
        """–ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∫–æ–º–∞–Ω–¥"""
        try:
            self.cursor.execute(
                """
                SELECT command, COUNT(*) as count 
                FROM commands 
                GROUP BY command 
                ORDER BY count DESC
                """
            )
            return self.cursor.fetchall()
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∫–æ–º–∞–Ω–¥: {e}")
            return []
    
    def get_user_stats(self):
        """–ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"""
        try:
            self.cursor.execute(
                """
                SELECT user_id, first_seen, last_seen, command_count 
                FROM users 
                ORDER BY command_count DESC
                """
            )
            return self.cursor.fetchall()
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {e}")
            return []

async def search_in_table2(query: str, context) -> list:
    """
    –ü–æ–∏—Å–∫ –≤ —Ç–∞–±–ª–∏—Ü–µ table_2.xlsx –ø–æ –∫–æ–ª–æ–Ω–∫–∞–º "–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ" –∏ "–û—Ç–¥–µ–ª"
    """
    try:
        # –ó–∞–¥–∞–µ–º —Ç–æ—á–Ω—ã–π –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É
        excel_file = "C:\\Users\\PluxuryPC\\PycharmProjects\\PythonProject5\\data\\table_2.xlsx"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–∞
        if not os.path.exists(excel_file):
            logger.error(f"‚ùå –§–∞–π–ª —Ç–∞–±–ª–∏—Ü—ã –Ω–µ –Ω–∞–π–¥–µ–Ω: {excel_file}")
            return ["‚ùå –§–∞–π–ª —Å —Ç–∞–±–ª–∏—Ü–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω"]
            
        # –ß–∏—Ç–∞–µ–º Excel —Ñ–∞–π–ª
        df = pd.read_excel(excel_file)
        logger.info(f"–ó–∞–≥—Ä—É–∂–µ–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫: {len(df)}")
        logger.info(f"–ö–æ–ª–æ–Ω–∫–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ: {df.columns.tolist()}")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –∫–æ–ª–æ–Ω–æ–∫
        required_columns = ['–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ', '–û—Ç–¥–µ–ª']
        missing_columns = [col for col in required_columns if col not in df.columns]
        
        if missing_columns:
            logger.error(f"‚ùå –í —Ç–∞–±–ª–∏—Ü–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –∫–æ–ª–æ–Ω–∫–∏: {', '.join(missing_columns)}")
            return ["‚ùå –û—à–∏–±–∫–∞ –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ —Ç–∞–±–ª–∏—Ü—ã: –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∫–æ–ª–æ–Ω–∫–∏"]

        # –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –ø—É—Å—Ç–æ–π, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–µ—Ä–≤—ã–µ 15 —Å—Ç—Ä–æ–∫
        if not query.strip():
            results = []
            for _, row in df.head(15).iterrows():
                result_parts = []
                result_parts.append(f"üè™ *{row['–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ']}*")
                
                # –î–æ–±–∞–≤–ª—è–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è
                for col in df.columns:
                    if col != '–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ':
                        value = row[col]
                        if pd.notna(value):  # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–µ NaN
                            # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —á–∏—Å–ª–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                            formatted_value = format_numeric_value(value)
                            result_parts.append(f"‚Ä¢ {col}: {formatted_value}")
                
                results.append("\n".join(result_parts))
            return results
            
        # –ü—Ä–∏–≤–æ–¥–∏–º –∑–∞–ø—Ä–æ—Å –∫ –Ω–∏–∂–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É –¥–ª—è –ø–æ–∏—Å–∫–∞
        query = query.lower().strip()
        logger.info(f"–ü–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å: {query}")

        # –ü–æ–∏—Å–∫ –ø–æ –∫–æ–ª–æ–Ω–∫–∞–º "–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ" –∏ "–û—Ç–¥–µ–ª"
        matches = df[
            df['–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ'].astype(str).str.lower().str.contains(query, na=False) |
            df['–û—Ç–¥–µ–ª'].astype(str).str.lower().str.contains(query, na=False)
        ]
        
        logger.info(f"–ù–∞–π–¥–µ–Ω–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π: {len(matches)}")
        
        if not matches.empty:
            # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
            results = []
            for _, row in matches.iterrows():
                result_parts = []
                result_parts.append(f"üè™ *{row['–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ']}*")
                
                # –î–æ–±–∞–≤–ª—è–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è
                for col in df.columns:
                    if col != '–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ':
                        value = row[col]
                        if pd.notna(value):  # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–µ NaN
                            # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —á–∏—Å–ª–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                            formatted_value = format_numeric_value(value)
                            result_parts.append(f"‚Ä¢ {col}: {formatted_value}")
                
                results.append("\n".join(result_parts))
            
            return results
        else:
            logger.info("–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ –∑–∞–ø—Ä–æ—Å—É")
            return []
                
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –≤ —Ç–∞–±–ª–∏—Ü–µ: {e}")
        import traceback
        logger.error(f"–î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏: {traceback.format_exc()}")
        return ["‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ"]

async def search_in_skobyanka_direct(query: str, context) -> list:
    """
    –ü–æ–∏—Å–∫ –≤ —Ç–∞–±–ª–∏—Ü–µ skobyanka.xlsx –ø–æ –≤—Å–µ–º –∫–æ–ª–æ–Ω–∫–∞–º
    """
    try:
        # –ó–∞–¥–∞–µ–º —Ç–æ—á–Ω—ã–π –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É
        excel_file = "C:\\Users\\PluxuryPC\\PycharmProjects\\PythonProject5\\data\\skobyanka.xlsx"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–∞
        if not os.path.exists(excel_file):
            logger.error(f"‚ùå –§–∞–π–ª —Å–∫–æ–±—è–Ω–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω: {excel_file}")
            return ["‚ùå –§–∞–π–ª —Å –∫–∞—Ç–∞–ª–æ–≥–æ–º —Å–∫–æ–±—è–Ω–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω"]
            
        # –ß–∏—Ç–∞–µ–º Excel —Ñ–∞–π–ª
        df = pd.read_excel(excel_file)
        logger.info(f"–ó–∞–≥—Ä—É–∂–µ–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ —Å–∫–æ–±—è–Ω–∫–∏. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫: {len(df)}")
        logger.info(f"–ö–æ–ª–æ–Ω–∫–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ: {df.columns.tolist()}")
        
        # –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –ø—É—Å—Ç–æ–π, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–µ—Ä–≤—ã–µ 15 —Å—Ç—Ä–æ–∫
        if not query.strip():
            results = []
            for _, row in df.head(15).iterrows():
                result_parts = []
                
                # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –æ—Å–Ω–æ–≤–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ/–∞—Ä—Ç–∏–∫—É–ª
                name_column = next((col for col in ['–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ', '–¢–æ–≤–∞—Ä', '–ê—Ä—Ç–∏–∫—É–ª'] if col in df.columns), df.columns[0])
                result_parts.append(f"üîß *{row[name_column]}*")
                
                # –î–æ–±–∞–≤–ª—è–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è
                for col in df.columns:
                    if col != name_column:
                        value = row[col]
                        if pd.notna(value):  # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–µ NaN
                            # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —á–∏—Å–ª–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ, —É–¥–∞–ª—è—è .0 —É —Ü–µ–ª—ã—Ö —á–∏—Å–µ–ª
                            formatted_value = format_numeric_value(value)
                            result_parts.append(f"‚Ä¢ {col}: {formatted_value}")
                
                results.append("\n".join(result_parts))
            return results
            
        # –ü—Ä–∏–≤–æ–¥–∏–º –∑–∞–ø—Ä–æ—Å –∫ –Ω–∏–∂–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É –¥–ª—è –ø–æ–∏—Å–∫–∞
        query = query.lower().strip()
        logger.info(f"–ü–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –¥–ª—è —Å–∫–æ–±—è–Ω–∫–∏: {query}")

        # –ü–æ–∏—Å–∫ –ø–æ –≤—Å–µ–º –∫–æ–ª–æ–Ω–∫–∞–º
        matches = df.apply(
            lambda row: any(
                str(value).lower().find(query) != -1 
                for value in row if pd.notna(value)
            ), 
            axis=1
        )
        
        results_df = df[matches]
        logger.info(f"–ù–∞–π–¥–µ–Ω–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π: {len(results_df)}")
        
        if not results_df.empty:
            # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è
            results = []
            for _, row in results_df.iterrows():
                result_parts = []
                
                # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –æ—Å–Ω–æ–≤–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ/–∞—Ä—Ç–∏–∫—É–ª
                name_column = next((col for col in ['–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ', '–¢–æ–≤–∞—Ä', '–ê—Ä—Ç–∏–∫—É–ª'] if col in df.columns), df.columns[0])
                result_parts.append(f"üîß *{row[name_column]}*")
                
                # –î–æ–±–∞–≤–ª—è–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è
                for col in df.columns:
                    if col != name_column:
                        value = row[col]
                        if pd.notna(value):  # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–µ NaN
                            # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —á–∏—Å–ª–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ, —É–¥–∞–ª—è—è .0 —É —Ü–µ–ª—ã—Ö —á–∏—Å–µ–ª
                            formatted_value = format_numeric_value(value)
                            result_parts.append(f"‚Ä¢ {col}: {formatted_value}")
                
                results.append("\n".join(result_parts))
            
            return results[:10]  # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–æ 10 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        else:
            return []
                
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –≤ —Å–∫–æ–±—è–Ω–∫–µ: {e}")
        import traceback
        logger.error(f"–î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏: {traceback.format_exc()}")
        return ["‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ"]

def format_numeric_value(value):
    """
    –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —á–∏—Å–ª–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –≤—ã–≤–æ–¥–∞, —É–¥–∞–ª—è—è –¥–µ—Å—è—Ç–∏—á–Ω—É—é —Ç–æ—á–∫—É –∏ –Ω—É–ª–∏ —É —Ü–µ–ª—ã—Ö —á–∏—Å–µ–ª
    """
    try:
        # –ï—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ - —á–∏—Å–ª–æ
        if isinstance(value, (int, float)):
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —á–∏—Å–ª–æ —Ü–µ–ª—ã–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, 450.0)
            if value.is_integer():
                return str(int(value))  # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ –±–µ–∑ .0
            else:
                return str(value)  # –û—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å –¥–ª—è –¥—Ä–æ–±–Ω—ã—Ö —á–∏—Å–µ–ª
        # –ï—Å–ª–∏ —ç—Ç–æ —É–∂–µ —Å—Ç—Ä–æ–∫–∞ –∏–ª–∏ –¥—Ä—É–≥–æ–π —Ç–∏–ø, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å
        return str(value)
    except:
        # –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –ø—Ä–æ—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ç—Ä–æ–∫–æ–≤–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ
        return str(value)


# –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–π Cloudinary
def initialize_cloudinary():
    """–ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Cloudinary - –≤—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç False"""
    logger.info("‚ö†Ô∏è Cloudinary API –æ—Ç–∫–ª—é—á–µ–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫")
    return False

# –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–∏ check_visual_search_availability
def check_visual_search_availability():
    """–ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ Visual Search –≤ Cloudinary - –≤—Å–µ–≥–¥–∞ False"""
    return False

# –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞ —á–µ—Ä–µ–∑ Cloudinary
def search_similar_images_cloudinary(image_path, max_results=5, folder=None):
    """–ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞ –≤ Cloudinary - –≤—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫"""
    logger.info("‚ö†Ô∏è –ü–æ–∏—Å–∫ —á–µ—Ä–µ–∑ Cloudinary –æ—Ç–∫–ª—é—á–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫")
    return []

def detect_tool_box(image):
    """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –≤ –∫–æ—Ä–æ–±–∫–µ"""
    try:
        # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ –æ—Ç—Ç–µ–Ω–∫–∏ —Å–µ—Ä–æ–≥–æ
        gray = cv2.cvtColor(image, cv2.COLOR_BGR2GRAY)
        
        # –ù–∞—Ö–æ–¥–∏–º –∫–æ–Ω—Ç—É—Ä—ã
        _, thresh = cv2.threshold(gray, 120, 255, cv2.THRESH_BINARY)
        contours, _ = cv2.findContours(thresh, cv2.RETR_EXTERNAL, cv2.CHAIN_APPROX_SIMPLE)
        
        # –ï—Å–ª–∏ –∫–æ–Ω—Ç—É—Ä–æ–≤ –Ω–µ—Ç, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º False
        if not contours:
            return False
        
        # –ü–æ–ª—É—á–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        height, width = image.shape[:2]
        image_area = height * width
        
        # –ò—â–µ–º –±–æ–ª—å—à–∏–µ –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω—ã–µ –∫–æ–Ω—Ç—É—Ä—ã (–ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –∫–æ—Ä–æ–±–∫–∏)
        for contour in contours:
            area = cv2.contourArea(contour)
            # –ï—Å–ª–∏ –∫–æ–Ω—Ç—É—Ä –∑–∞–Ω–∏–º–∞–µ—Ç –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—É—é —á–∞—Å—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            if area > image_area * 0.3:
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–æ—Å—Ç—å –∫–æ–Ω—Ç—É—Ä–∞
                perimeter = cv2.arcLength(contour, True)
                approx = cv2.approxPolyDP(contour, 0.04 * perimeter, True)
                if len(approx) == 4:  # –ü—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫
                    return True
        
        # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö —Ü–≤–µ—Ç–æ–≤ –¥–ª—è –∫–æ—Ä–æ–±–æ–∫ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
        # –ú–Ω–æ–≥–∏–µ –∫–æ—Ä–æ–±–∫–∏ –∏–º–µ—é—Ç —è—Ä–∫–∏–µ —Ü–≤–µ—Ç–∞ (Makita - —Å–∏–Ω–∏–π, DeWalt - –∂–µ–ª—Ç—ã–π)
        hsv = cv2.cvtColor(image, cv2.COLOR_BGR2HSV)
        
        # –°–∏–Ω–∏–µ –∫–æ—Ä–æ–±–∫–∏ (Makita, Bosch, Dexter)
        lower_blue = np.array([90, 50, 50])
        upper_blue = np.array([130, 255, 255])
        blue_mask = cv2.inRange(hsv, lower_blue, upper_blue)
        blue_pixels = cv2.countNonZero(blue_mask)
        
        # –ñ–µ–ª—Ç—ã–µ –∫–æ—Ä–æ–±–∫–∏ (DeWalt)
        lower_yellow = np.array([20, 100, 100])
        upper_yellow = np.array([35, 255, 255])
        yellow_mask = cv2.inRange(hsv, lower_yellow, upper_yellow)
        yellow_pixels = cv2.countNonZero(yellow_mask)
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ—Ä–æ–≥ –¥–ª—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –∫–æ—Ä–æ–±–∫–∏
        if blue_pixels > image_area * 0.2 or yellow_pixels > image_area * 0.2:
            return True
            
        return False
        
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏ –∫–æ—Ä–æ–±–∫–∏: {e}")
        return False

def extract_tool_from_box(image):
    """–ò–∑–≤–ª–µ–∫–∞–µ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –∏–∑ –∫–æ—Ä–æ–±–∫–∏, —Ñ–æ–∫—É—Å–∏—Ä—É—è—Å—å –Ω–∞ —Å–∞–º–æ–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–µ"""
    try:
        # –†–∞–∑–º–µ—Ä—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        height, width = image.shape[:2]
        
        # –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ü–µ–Ω—Ç—Ä–µ –∫–æ—Ä–æ–±–∫–∏
        # –í—ã—Ä–µ–∑–∞–µ–º —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—É—é —á–∞—Å—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        center_x, center_y = width // 2, height // 2
        
        # –ü–æ–ª—É—á–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã ROI (60-80% –æ—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è)
        roi_width = int(width * 0.7)
        roi_height = int(height * 0.7)
        
        # –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤–µ—Ä—Ö–Ω–µ–≥–æ –ª–µ–≤–æ–≥–æ —É–≥–ª–∞ ROI
        x1 = max(0, center_x - roi_width // 2)
        y1 = max(0, center_y - roi_height // 2)
        
        # –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –Ω–∏–∂–Ω–µ–≥–æ –ø—Ä–∞–≤–æ–≥–æ —É–≥–ª–∞ ROI
        x2 = min(width, x1 + roi_width)
        y2 = min(height, y1 + roi_height)
        
        # –í—ã—Ä–µ–∑–∞–µ–º ROI
        roi = image[y1:y2, x1:x2]
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–æ–ª—É—á–∏–ª–∏ –ª–∏ –º—ã —á—Ç–æ-—Ç–æ –ø–æ–ª–µ–∑–Ω–æ–µ
        if roi.size == 0:
            logger.warning("–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å ROI, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ")
            return image
            
        return roi
        
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ –∏–∑ –∫–æ—Ä–æ–±–∫–∏: {e}")
        return None

# –î–æ–±–∞–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ YOLO
def initialize_yolo_model():
    """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥–µ–ª–∏ YOLO –¥–ª—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –æ–±—ä–µ–∫—Ç–æ–≤"""
    global yolo_model
    try:
        # –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ –æ–±—É—á–µ–Ω–Ω—É—é –º–æ–¥–µ–ª—å YOLOv8n
        yolo_model = YOLO("yolov8n.pt")
        logger.info("‚úÖ –ú–æ–¥–µ–ª—å YOLO —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞")
        return True
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –º–æ–¥–µ–ª–∏ YOLO: {e}")
        import traceback
        logger.error(f"–î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏: {traceback.format_exc()}")
        return False

# –î–æ–±–∞–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏
def detect_tools_on_image(image_path):
    """–û–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏—Ö –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞—é—â–∏–µ —Ä–∞–º–∫–∏"""
    global yolo_model
    
    try:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –ª–∏ –º–æ–¥–µ–ª—å YOLO
        if yolo_model is None:
            if not initialize_yolo_model():
                return []
                
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–ª–∞—Å—Å—ã, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
        # YOLO COCO –∫–ª–∞—Å—Å—ã, –æ—Ç–Ω–æ—Å—è—â–∏–µ—Å—è –∫ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º –∏–ª–∏ –ø–æ—Ö–æ–∂–∏–º –æ–±—ä–µ–∫—Ç–∞–º
        tool_class_ids = [39, 40, 41, 42, 43, 44, 45, 76, 77]  # cell phone, mouse, remote, keyboard, laptop, –∏ —Ç.–¥.
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–≤
        results = yolo_model(image_path)
        
        # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–∞—Ö
        detected_objects = []
        
        if len(results) > 0:
            result = results[0]  # –ë–µ—Ä–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            boxes = result.boxes  # –ü–æ–ª—É—á–∞–µ–º –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞—é—â–∏–µ —Ä–∞–º–∫–∏
            
            for i, box in enumerate(boxes):
                # –ü–æ–ª—É—á–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ä–∞–º–∫–∏
                x1, y1, x2, y2 = box.xyxy[0].cpu().numpy()
                # –û–∫—Ä—É–≥–ª—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –¥–æ —Ü–µ–ª—ã—Ö —á–∏—Å–µ–ª
                x1, y1, x2, y2 = int(x1), int(y1), int(x2), int(y2)
                
                # –ü–æ–ª—É—á–∞–µ–º –∫–ª–∞—Å—Å –∏ –¥–æ—Å—Ç–æ–≤–µ—Ä–Ω–æ—Å—Ç—å
                cls = int(box.cls[0].item())
                conf = float(box.conf[0].item())
                
                # –ï—Å–ª–∏ –∫–ª–∞—Å—Å –Ω–µ –≤—Ö–æ–¥–∏—Ç –≤ –Ω–∞—à —Å–ø–∏—Å–æ–∫, –ø—Ä–æ–≤–µ—Ä—è–µ–º —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å
                # –°—á–∏—Ç–∞–µ–º, —á—Ç–æ –ª—é–±–æ–π –æ–±—ä–µ–∫—Ç —Å –≤—ã—Å–æ–∫–æ–π —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å—é –º–æ–∂–µ—Ç –±—ã—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–º
                is_tool = cls in tool_class_ids or conf > 0.70
                
                if is_tool:
                    detected_objects.append({
                        'bbox': (x1, y1, x2, y2),
                        'confidence': conf,
                        'class_id': cls,
                        'class_name': result.names.get(cls, 'unknown')
                    })
            
            logger.info(f"–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ {len(detected_objects)} –æ–±—ä–µ–∫—Ç–æ–≤ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏")
        
        # –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –æ–±—ä–µ–∫—Ç—ã —á–µ—Ä–µ–∑ YOLO, –¥–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞–∫ –æ–¥–∏–Ω –æ–±—ä–µ–∫—Ç
        if not detected_objects:
            # –ü–æ–ª—É—á–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            img = cv2.imread(image_path)
            height, width = img.shape[:2]
            detected_objects.append({
                'bbox': (0, 0, width, height),
                'confidence': 1.0,
                'class_id': -1,
                'class_name': 'full_image'
            })
            logger.info("–ù–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ –æ–±—ä–µ–∫—Ç–æ–≤, –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤—Å–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ")
            
        return detected_objects
        
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤: {e}")
        import traceback
        logger.error(f"–î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏: {traceback.format_exc()}")
        return []

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞—é—â–µ–π —Ä–∞–º–∫–∏
def extract_tool_by_bbox(image_path, bbox):
    """–ò–∑–≤–ª–µ–∫–∞–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞—é—â–µ–π —Ä–∞–º–∫–∏"""
    try:
        # –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        img = cv2.imread(image_path)
        if img is None:
            logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ: {image_path}")
            return None
            
        # –ò–∑–≤–ª–µ–∫–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ä–∞–º–∫–∏
        x1, y1, x2, y2 = bbox
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥—Ä–∞–Ω–∏—Ü—ã
        height, width = img.shape[:2]
        x1 = max(0, x1)
        y1 = max(0, y1)
        x2 = min(width, x2)
        y2 = min(height, y2)
        
        # –í—ã—Ä–µ–∑–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
        cropped_img = img[y1:y2, x1:x2]
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–æ–ª—É—á–∏–ª–æ—Å—å –ª–∏ —á—Ç–æ-—Ç–æ –≤—ã—Ä–µ–∑–∞—Ç—å
        if cropped_img.size == 0:
            logger.warning(f"–ü–æ–ª—É—á–µ–Ω –ø—É—Å—Ç–æ–π crop –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º {bbox}")
            return None
            
        # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
        temp_path = os.path.join("temp", f"tool_crop_{uuid.uuid4()}.jpg")
        cv2.imwrite(temp_path, cropped_img)
        
        return temp_path
        
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞: {e}")
        import traceback
        logger.error(f"–î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏: {traceback.format_exc()}")
        return None

def main():
    if not os.path.exists("config.encrypted"):
        logger.error("‚ùå –ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–∞–π–ª 'config.encrypted' –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–ª–∏—á–∏–µ.")
        return
    config = load_config()
    if not config:
        logger.error("‚ùå –ü—Ä–æ–≥—Ä–∞–º–º–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –∏–∑-–∑–∞ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–µ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏.")
        return

    token = config.get("telegram_token")
    
    logger.info("‚ö†Ô∏è Cloudinary API –æ—Ç–∫–ª—é—á–µ–Ω–æ, –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è —Ç–æ–ª—å–∫–æ –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫")
    
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥–µ–ª–µ–π –ø–æ–∏—Å–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
    logger.info("üîÑ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥–µ–ª–µ–π –ø–æ–∏—Å–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π...")
    try:
        if not initialize_image_search():
            logger.warning("‚ö†Ô∏è –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –º–æ–¥–µ–ª–µ–π –ø–æ–∏—Å–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π")
            logger.warning("–õ–æ–∫–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ –ø–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º –±—É–¥–µ—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω")
        else:
            # –ü—Ä–æ–±—É–µ–º –æ–±–Ω–æ–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å, –µ—Å–ª–∏ –µ—Å—Ç—å –ø–∞–ø–∫–∞ —Å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è–º–∏
            photos_folder = config.get("photos_folder")
            if photos_folder and os.path.exists(photos_folder):
                logger.info("üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π...")
                if not update_image_index(photos_folder):
                    logger.warning("‚ö†Ô∏è –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π")
                    logger.warning("–õ–æ–∫–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ –ø–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ")
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–∏—Å—Ç–µ–º—ã –ø–æ–∏—Å–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π: {e}")
        logger.warning("–ë–æ—Ç –±—É–¥–µ—Ç –∑–∞–ø—É—â–µ–Ω –±–µ–∑ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞ –ø–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º")
    
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
    analytics = Analytics()
    logger.info("–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞")
    
    application = Application.builder().token(token).build()
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∞–Ω–∞–ª–∏—Ç–∏–∫—É –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –±–æ—Ç–∞
    application.bot_data['analytics'] = analytics

    # –ò–∑–º–µ–Ω—è–µ–º –ø–æ—Ä—è–¥–æ–∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
    # –°–Ω–∞—á–∞–ª–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥
    application.add_handler(CommandHandler("start", start))
    application.add_handler(CommandHandler("help", help_handler))
    application.add_handler(CommandHandler("stop", stop_handler))
    application.add_handler(CommandHandler("stats", get_stats_handler))
    
    # –ó–∞—Ç–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ –º–µ–Ω—é
    application.add_handler(MessageHandler(filters.Regex("^‚ùì –ü–æ–º–æ—â—å$"), help_handler))
    application.add_handler(MessageHandler(filters.Regex("^üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã$"), contacts_handler))
    application.add_handler(MessageHandler(filters.Regex("^üì∏ –ü–æ–∏—Å–∫ –ø–æ —Ñ–æ—Ç–æ$"), photo_search_handler))
    
    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –ø–æ–¥—Ä–∞–∑–¥–µ–ª–æ–≤
    application.add_handler(MessageHandler(filters.Regex("^üè™ –ú–∞–≥–∞–∑–∏–Ω—ã$"), stores_handler))
    application.add_handler(MessageHandler(filters.Regex("^üöö –õ–æ–≥–∏—Å—Ç–∏–∫–∞$"), logistics_handler))
    application.add_handler(MessageHandler(filters.Regex("^üó∫ –ö–∞—Ä—Ç—ã$"), maps_handler))
    application.add_handler(MessageHandler(filters.Regex("^üîß –°–∫–æ–±—è–Ω–∫–∞$"), skobyanka_handler))
    application.add_handler(MessageHandler(filters.Regex("^üé® –¶–≤–µ—Ç–∞$"), colors_base_handler))
    application.add_handler(MessageHandler(filters.Regex("^üìÑ –ï–ì–ê–ò–°$"), egais_handler))
    
    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
    application.add_handler(MessageHandler(filters.Regex("^üîô –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é$"), back_to_menu_handler))
    application.add_handler(MessageHandler(filters.Regex("^üîô –ù–∞–∑–∞–¥ –≤ –∫–æ–Ω—Ç–∞–∫—Ç—ã$"), back_to_contacts_handler))
    application.add_handler(MessageHandler(filters.Regex("^üîô –ù–∞–∑–∞–¥ –∫ –≤—ã–±–æ—Ä—É –æ—Ç–¥–µ–ª–∞$"), back_to_departments_handler))

    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞ –æ—Ç–¥–µ–ª–∞
    application.add_handler(MessageHandler(filters.Regex("^üé® –ö—Ä–∞—Å–∫–∞$"), department_selection_handler))
    application.add_handler(MessageHandler(filters.Regex("^üß± –°—Ç—Ä–æ–π–∫–∞$"), department_selection_handler))
    application.add_handler(MessageHandler(filters.Regex("^ü™ë –°—Ç–æ–ª—è—Ä–∫–∞$"), department_selection_handler))
    application.add_handler(MessageHandler(filters.Regex("^‚ö° –≠–ª–µ–∫—Ç—Ä–∏–∫–∞$"), department_selection_handler))
    application.add_handler(MessageHandler(filters.Regex("^üî® –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã$"), department_selection_handler))
    application.add_handler(MessageHandler(filters.Regex("^üöø –í–æ–¥–æ—Å–Ω–∞–±–∂–µ–Ω–∏–µ$"), department_selection_handler))
    application.add_handler(MessageHandler(filters.Regex("^üå± –°–∞–¥$"), department_selection_handler))
    application.add_handler(MessageHandler(filters.Regex("^üîß –°–∫–æ–±—è–Ω–∫–∞$"), department_selection_handler))

    # –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    application.add_handler(MessageHandler(filters.Regex("^üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞$"), statistics_handler))

    # –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
    application.add_handler(CommandHandler("admin", admin_panel_handler))
    application.add_handler(MessageHandler(filters.Regex("^üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏$"), user_management_handler))
    application.add_handler(MessageHandler(filters.Regex("^‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è$"), add_user_handler))
    application.add_handler(MessageHandler(filters.Regex("^‚ûñ –£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è$"), remove_user_handler))
    application.add_handler(MessageHandler(filters.Regex("^üìã –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π$"), list_users_handler))
    application.add_handler(MessageHandler(filters.Regex("^üîô –ù–∞–∑–∞–¥ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å$"), back_to_admin_panel_handler))

    # –û–±—â–∏–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–º
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, text_handler))
    
    # –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã add_user
    application.add_handler(CommandHandler("add_user", add_user_command))

    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π
    application.add_handler(MessageHandler(filters.PHOTO, photo_handler))

    # –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
    logger.info("ü§ñ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω...")
    application.run_polling(allowed_updates=Update.ALL_TYPES)

if __name__ == '__main__':
    logger.info("–ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞...")
    if not os.path.exists("config.encrypted"):
        logger.error("‚ùå –ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–∞–π–ª 'config.encrypted' –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–ª–∏—á–∏–µ.")
        exit()  # –ó–∞–≤–µ—Ä—à–∞–µ–º –ø—Ä–æ–≥—Ä–∞–º–º—É
    logger.info("–§–∞–π–ª –Ω–∞–π–¥–µ–Ω.")

    logger.info("–ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é...")
    config = load_config()
    if not config:
        logger.error("‚ùå –ü—Ä–æ–≥—Ä–∞–º–º–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –∏–∑-–∑–∞ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–µ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏.")
        exit()

    logger.info("–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–∞.")
    logger.info("–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞...")
    main()